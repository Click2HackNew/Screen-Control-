<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Control - Live View</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #121212; 
            color: #e0e0e0; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden;
        }
        
        /* VIEWS */
        .view { 
            display: none; 
            width: 100%; 
            height: 100%; 
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .view.active { 
            display: flex; 
            flex-direction: column; 
        }
        
        /* DEVICE LIST VIEW */
        #device-list-view { 
            flex-direction: column; 
            background: #121212;
        }
        
        .header { 
            background-color: #1e1e1e; 
            padding: 15px 20px; 
            text-align: center; 
            border-bottom: 3px solid #00ff00; 
            flex-shrink: 0; 
        }
        
        .header h1 { 
            font-family: 'Orbitron', sans-serif; 
            margin: 0; 
            font-size: 1.8em; 
            color: #00ff00; 
            text-shadow: 0 0 10px #00ff00; 
        }
        
        #device-list-container { 
            padding: 20px; 
            overflow-y: auto; 
            flex-grow: 1; 
        }
        
        #device-list { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 15px; 
        }
        
        .device { 
            background-color: #1e1e1e; 
            border-radius: 12px; 
            border-left: 6px solid #555; 
            padding: 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border: 1px solid #333;
        }
        
        .device:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 25px rgba(0,255,0,0.2); 
            border-left-color: #00ff00; 
            border-color: #00ff00;
        }
        
        .device-name { 
            font-size: 1.4em; 
            font-weight: 700; 
            margin-bottom: 5px;
        }
        
        .device-info { 
            font-size: 0.95em; 
            color: #aaa; 
        }
        
        .status-dot { 
            height: 16px; 
            width: 16px; 
            background-color: #28a745; 
            border-radius: 50%; 
            display: inline-block; 
            box-shadow: 0 0 10px #28a745; 
        }
        
        .lock-badge { 
            background: #ff4444; 
            color: white; 
            padding: 3px 10px; 
            border-radius: 12px; 
            font-size: 0.85em; 
            margin-left: 10px; 
            font-weight: bold;
        }
        
        .lock-badge.unlocked { 
            background: #44ff44; 
            color: #000;
        }
        
        /* CONTROL VIEW - FULL SCREEN */
        #control-view { 
            flex-direction: column; 
            background: #000;
        }
        
        .control-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 20px; 
            background-color: #1a1a1a; 
            border-bottom: 2px solid #333; 
            flex-wrap: wrap; 
            gap: 12px; 
            flex-shrink: 0; 
            z-index: 100;
        }
        
        #back-to-list-btn { 
            background-color: #3f3f46; 
            color: white; 
            border: 1px solid #555; 
            padding: 10px 18px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: bold;
            transition: all 0.2s;
        }
        
        #back-to-list-btn:hover {
            background-color: #555;
        }
        
        #device-title { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }
        
        .lock-info { 
            background: #2a2a2a; 
            padding: 6px 12px; 
            border-radius: 6px; 
            font-size: 0.95em; 
            border: 1px solid #444;
        }
        
        .screen-toggle-buttons { 
            display: flex; 
            gap: 10px; 
        }
        
        .screen-toggle-btn { 
            background: #3f3f46; 
            color: white; 
            border: 1px solid #555; 
            padding: 10px 18px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.95em; 
            font-weight: bold;
            transition: all 0.3s; 
        }
        
        .screen-toggle-btn:hover { 
            background: #555; 
        }
        
        .screen-toggle-btn.active { 
            background: #00ff00; 
            color: #000; 
            border-color: #00ff00; 
            box-shadow: 0 0 10px #00ff00;
        }
        
        /* FULL SCREEN CONTAINER */
        .main-container { 
            display: flex; 
            flex-grow: 1; 
            min-height: 0; 
            overflow: hidden;
            background: #000;
            position: relative;
        }
        
        /* SCREEN AREA - FULL SCREEN */
        .screen-area { 
            flex-grow: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0;
            position: relative; 
            overflow: hidden;
            background: #000;
            width: 100%;
            height: 100%;
        }
        
        .screen-viewport { 
            border: none;
            background-color: #000; 
            overflow: hidden; 
            position: relative; 
            width: 100%;
            height: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        
        /* FULL SCREEN IMAGE - COLORFUL */
        .live-screen-image { 
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000; 
            cursor: crosshair;
            image-rendering: optimizeQuality;
            filter: brightness(1.1) contrast(1.1) saturate(1.2);
        }
        
        /* IMAGE CONTAINER FOR BETTER CLICK HANDLING */
        .image-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        
        /* CLICK OVERLAY FOR DEBUGGING */
        .click-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .click-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(255, 0, 0, 0.7);
            border: 2px solid #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
            display: none;
        }
        
        /* CONTROLS */
        .all-controls { 
            width: 90px; 
            background-color: rgba(30, 30, 30, 0.95); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            gap: 15px; 
            padding: 25px 12px; 
            flex-shrink: 0; 
            overflow-y: auto;
            border-left: 2px solid #333;
            z-index: 50;
        }
        
        .control-button { 
            width: 65px; 
            height: 65px; 
            background-color: #3f3f46; 
            border: 2px solid #555; 
            color: white; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 28px; 
            transition: all 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0;
            font-weight: bold;
        }
        
        .control-button:hover { 
            background-color: #555; 
            transform: scale(1.05);
            border-color: #00ff00;
        }
        
        .divider { 
            height: 2px; 
            width: 80%; 
            background-color: #444; 
            margin: 15px 0; 
        }
        
        /* STATUS INDICATORS */
        .status-indicator { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.95em; 
            flex-shrink: 0; 
        }
        
        .live-indicator { 
            width: 12px; 
            height: 12px; 
            background-color: #ff4444; 
            border-radius: 50%; 
            animation: pulse 1.5s infinite; 
        }
        
        .live-indicator.active { 
            background-color: #44ff44; 
            box-shadow: 0 0 10px #44ff44;
        }
        
        @keyframes pulse { 
            0% { opacity: 1; } 
            50% { opacity: 0.5; } 
            100% { opacity: 1; } 
        }
        
        .connection-status { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.95em; 
            padding: 8px 12px; 
            border-radius: 6px; 
            background: #2a2a2a; 
            border: 1px solid #444;
        }
        
        .connection-dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
        }
        
        .connection-dot.connected { 
            background-color: #44ff44; 
            box-shadow: 0 0 10px #44ff44; 
        }
        
        .connection-dot.disconnected { 
            background-color: #ff4444; 
            box-shadow: 0 0 10px #ff4444; 
        }
        
        .connection-stats { 
            font-size: 0.85em; 
            color: #aaa; 
            margin-top: 3px; 
        }
        
        /* MAIN BUTTON */
        .single-main-btn { 
            background: linear-gradient(135deg, #0066cc, #0099ff); 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 8px; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.4); 
            transition: all 0.3s; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-shrink: 0; 
        }
        
        .single-main-btn:hover { 
            background: linear-gradient(135deg, #0099ff, #00ccff); 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(0, 153, 255, 0.6); 
        }
        
        /* DEBUG INFO */
        .debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        
        .coords-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        
        /* TEST CLICK MODE */
        .test-click-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.1);
            border: 2px dashed red;
            padding: 20px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="device-list-view" class="view active">
        <div class="header"><h1>üîì PERMANENT CONNECTION CONTROL</h1></div>
        <div id="device-list-container"><ul id="device-list"></ul></div>
    </div>

    <div id="control-view" class="view">
        <div class="control-header">
            <button id="back-to-list-btn">‚Üê Back to List</button>
            <h2 id="device-title"></h2>
            <div class="lock-info" id="lock-status">Lock: Unknown</div>
            <div class="screen-toggle-buttons">
                <button id="btn-live-screen" class="screen-toggle-btn active">üì± LIVE SCREEN</button>
                <button id="btn-test-click" class="screen-toggle-btn" style="background: #ff9900;">üéØ TEST CLICK</button>
            </div>
            <div class="status-indicator">
                <div id="live-indicator" class="live-indicator"></div>
                <span id="stream-status">Stream: Off</span>
            </div>
            <div class="connection-status">
                <div id="connection-dot" class="connection-dot disconnected"></div>
                <span id="connection-status-text">Connecting...</span>
                <div class="connection-stats" id="connection-stats"></div>
            </div>
            <button id="btn-wake-unlock" class="single-main-btn">‚ö° WAKE & UNLOCK</button>
        </div>
        <div class="main-container">
            <div class="screen-area">
                <div id="live-screen-viewport" class="screen-viewport" style="display: block;">
                    <div class="image-container">
                        <img id="live-screen-image" class="live-screen-image" src="" alt="Live Screen" />
                        <div class="click-overlay">
                            <div id="click-marker" class="click-marker"></div>
                        </div>
                        <div id="coords-display" class="coords-display">Click: x=0, y=0</div>
                        <div id="debug-info" class="debug-info">Debug Info</div>
                        <div id="test-click-area" class="test-click-area">
                            <h3>üéØ Test Click Mode</h3>
                            <p>Click on the colored squares below to test</p>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <div class="test-btn" data-x="100" data-y="200" style="background: red; padding: 10px; cursor: pointer;">Red Button</div>
                                <div class="test-btn" data-x="300" data-y="200" style="background: blue; padding: 10px; cursor: pointer;">Blue Button</div>
                                <div class="test-btn" data-x="500" data-y="200" style="background: green; padding: 10px; cursor: pointer;">Green Button</div>
                            </div>
                            <button onclick="document.getElementById('test-click-area').style.display='none'" style="margin-top: 10px;">Close Test</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="all-controls">
                <button class="control-button" id="btn-scroll-up">‚Üë</button>
                <div style="display: flex; gap: 5px;">
                    <button class="control-button" id="btn-scroll-left">‚Üê</button>
                    <button class="control-button" id="btn-scroll-right">‚Üí</button>
                </div>
                <button class="control-button" id="btn-scroll-down">‚Üì</button>
                <div class="divider"></div>
                <button class="control-button" id="btn-back">‚Æå</button>
                <button class="control-button" id="btn-home">‚åÇ</button>
                <button class="control-button" id="btn-recents">‚ñ°</button>
                <div class="divider"></div>
                <button class="control-button" id="btn-start-stream">‚ñ∂Ô∏è</button>
                <button class="control-button" id="btn-stop-stream">‚è∏Ô∏è</button>
                <button class="control-button" id="btn-calibrate-click" style="background: #ff4444;">üéØ</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ENHANCED SOCKET CONNECTION
        const socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 10000,
            randomizationFactor: 0.3,
            timeout: 20000,
            transports: ['websocket', 'polling'],
            autoConnect: true,
            forceNew: false,
            multiplex: false
        });

        const UIElements = {
            deviceListView: document.getElementById('device-list-view'),
            controlView: document.getElementById('control-view'),
            deviceList: document.getElementById('device-list'),
            deviceTitle: document.getElementById('device-title'),
            lockStatus: document.getElementById('lock-status'),
            backToListBtn: document.getElementById('back-to-list-btn'),
            liveScreenBtn: document.getElementById('btn-live-screen'),
            testClickBtn: document.getElementById('btn-test-click'),
            liveScreenViewport: document.getElementById('live-screen-viewport'),
            liveScreenImage: document.getElementById('live-screen-image'),
            connectionDot: document.getElementById('connection-dot'),
            connectionStatusText: document.getElementById('connection-status-text'),
            connectionStats: document.getElementById('connection-stats'),
            liveIndicator: document.getElementById('live-indicator'),
            streamStatus: document.getElementById('stream-status'),
            clickMarker: document.getElementById('click-marker'),
            coordsDisplay: document.getElementById('coords-display'),
            debugInfo: document.getElementById('debug-info'),
            testClickArea: document.getElementById('test-click-area'),
            calibrateClickBtn: document.getElementById('btn-calibrate-click')
        };

        // STATE MANAGEMENT
        let state = {
            devices: {},
            activeDeviceId: null,
            connectionStartTime: 0,
            isLiveStreaming: false,
            currentScreenView: 'live',
            lastPingTime: Date.now(),
            connectionAttempts: 0,
            deviceConnectionState: new Map(),
            retryTimeout: null,
            screenDimensions: { width: 0, height: 0 },
            clickHistory: [],
            debugMode: false,
            colorEnhancement: true,
            currentImageData: null,
            calibrationOffset: { x: 0, y: 0 },
            scaleFactor: 1.0
        };

        // ENHANCED CLICK HANDLER WITH CALIBRATION
        function setupClickHandler() {
            UIElements.liveScreenImage.addEventListener('click', handleScreenClick);
            UIElements.liveScreenImage.addEventListener('contextmenu', handleRightClick);
            
            // Test click buttons
            document.querySelectorAll('.test-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const x = parseInt(this.getAttribute('data-x'));
                    const y = parseInt(this.getAttribute('data-y'));
                    sendClickCommand(x, y, 'test-click');
                });
            });
            
            console.log('üéØ Click handler setup with calibration');
        }

        function handleScreenClick(e) {
            if (!state.isLiveStreaming || !state.activeDeviceId) {
                console.warn('Cannot click: No active stream or device');
                return;
            }

            const rect = e.target.getBoundingClientRect();
            const imageElement = e.target;
            
            // Get actual displayed image dimensions
            const containerWidth = rect.width;
            const containerHeight = rect.height;
            const imageAspectRatio = imageElement.naturalWidth / imageElement.naturalHeight;
            const containerAspectRatio = containerWidth / containerHeight;
            
            let imageWidth, imageHeight, offsetX = 0, offsetY = 0;
            
            if (containerAspectRatio > imageAspectRatio) {
                // Image is height-constrained
                imageHeight = containerHeight;
                imageWidth = imageHeight * imageAspectRatio;
                offsetX = (containerWidth - imageWidth) / 2;
            } else {
                // Image is width-constrained
                imageWidth = containerWidth;
                imageHeight = imageWidth / imageAspectRatio;
                offsetY = (containerHeight - imageHeight) / 2;
            }
            
            // Calculate click position relative to actual image
            const clickX = e.clientX - rect.left - offsetX;
            const clickY = e.clientY - rect.top - offsetY;
            
            // Check if click is within image bounds
            if (clickX < 0 || clickY < 0 || clickX > imageWidth || clickY > imageHeight) {
                console.warn('Click outside image area');
                return;
            }
            
            // Scale to original image coordinates
            const scaleX = imageElement.naturalWidth / imageWidth;
            const scaleY = imageElement.naturalHeight / imageHeight;
            
            // Apply calibration offset
            const calibratedX = Math.round((clickX * scaleX) + state.calibrationOffset.x);
            const calibratedY = Math.round((clickY * scaleY) + state.calibrationOffset.y);
            
            // Clamp to screen bounds
            const finalX = Math.max(0, Math.min(calibratedX, imageElement.naturalWidth - 1));
            const finalY = Math.max(0, Math.min(calibratedY, imageElement.naturalHeight - 1));
            
            // Show visual feedback
            showClickFeedback(clickX + offsetX, clickY + offsetY, finalX, finalY);
            
            // Send click command
            sendClickCommand(finalX, finalY, 'screen-click');
        }

        function handleRightClick(e) {
            e.preventDefault();
            if (!state.isLiveStreaming) return;
            
            const rect = e.target.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            // Calibration mode - set offset
            state.calibrationOffset.x += 10;
            state.calibrationOffset.y += 10;
            
            UIElements.debugInfo.innerHTML = `
                üîß Calibration Adjusted<br>
                Offset: +${state.calibrationOffset.x}, +${state.calibrationOffset.y}<br>
                Click at: ${Math.round(clickX)}, ${Math.round(clickY)}
            `;
            UIElements.debugInfo.style.display = 'block';
            
            setTimeout(() => {
                UIElements.debugInfo.style.display = 'none';
            }, 3000);
            
            console.log(`üîß Calibration offset: ${state.calibrationOffset.x}, ${state.calibrationOffset.y}`);
        }

        function sendClickCommand(x, y, type = 'touch') {
            console.log(`üéØ Sending ${type}: x=${x}, y=${y}`);
            
            sendCommand('touch_command', { 
                x: x, 
                y: y,
                type: type,
                timestamp: Date.now(),
                calibration: state.calibrationOffset
            });
            
            // Store in history
            state.clickHistory.push({
                x: x,
                y: y,
                type: type,
                timestamp: Date.now(),
                success: null
            });
            
            // Keep only recent history
            if (state.clickHistory.length > 20) {
                state.clickHistory.shift();
            }
        }

        function showClickFeedback(screenX, screenY, originalX, originalY) {
            // Show marker
            UIElements.clickMarker.style.left = `${screenX}px`;
            UIElements.clickMarker.style.top = `${screenY}px`;
            UIElements.clickMarker.style.display = 'block';
            
            // Update coordinates display
            UIElements.coordsDisplay.textContent = `Click: x=${originalX}, y=${originalY}`;
            UIElements.coordsDisplay.style.display = 'block';
            
            // Auto-hide
            setTimeout(() => {
                UIElements.clickMarker.style.display = 'none';
                setTimeout(() => {
                    UIElements.coordsDisplay.style.display = 'none';
                }, 2000);
            }, 1000);
        }

        function calibrateClick() {
            // Reset calibration
            state.calibrationOffset = { x: 0, y: 0 };
            
            // Show test area
            UIElements.testClickArea.style.display = 'block';
            
            UIElements.debugInfo.innerHTML = `
                üéØ Calibration Mode Active<br>
                Click the test buttons or screen<br>
                Right-click to adjust offset
            `;
            UIElements.debugInfo.style.display = 'block';
            
            console.log('üîß Entering calibration mode');
        }

        // SOCKET FUNCTIONS
        function sendCommand(action, payload = {}) {
            if (!state.activeDeviceId) {
                console.warn('No active device selected');
                return;
            }
            
            if (!socket.connected) {
                console.warn('Socket not connected, attempting to reconnect...');
                UIElements.connectionStatusText.textContent = 'Reconnecting...';
                socket.connect();
                
                if (!state.pendingCommands) state.pendingCommands = [];
                state.pendingCommands.push({ action, payload, timestamp: Date.now() });
                return;
            }
            
            const seq = Date.now();
            const commandData = {
                deviceId: state.activeDeviceId,
                action,
                payload: { ...payload, _seq: seq }
            };
            
            console.log(`üì§ Sending ${action} to ${state.activeDeviceId}`);
            socket.emit('command_to_device', commandData);
        }

        function startLiveStream() {
            if (state.isLiveStreaming) return;
            
            console.log('üöÄ Starting live stream');
            state.isLiveStreaming = true;
            
            sendCommand('start_live_stream');
            
            UIElements.liveIndicator.classList.add('active');
            UIElements.streamStatus.textContent = 'Stream: ON';
            UIElements.streamStatus.style.color = '#44ff44';
            
            // Setup click handler when image loads
            UIElements.liveScreenImage.onload = function() {
                console.log('üñºÔ∏è Image loaded, click handler ready');
            };
            
            clearTimeout(state.retryTimeout);
        }

        function stopLiveStream() {
            if (!state.isLiveStreaming) return;
            
            console.log('üõë Stopping live stream');
            state.isLiveStreaming = false;
            
            sendCommand('stop_live_stream');
            
            UIElements.liveIndicator.classList.remove('active');
            UIElements.streamStatus.textContent = 'Stream: OFF';
            UIElements.streamStatus.style.color = '#ff4444';
            
            clearTimeout(state.retryTimeout);
        }

        // DEVICE MANAGEMENT
        function updateDeviceInList(device) {
            if (!device || !device.deviceId) return;
            
            const deviceId = device.deviceId;
            state.devices[deviceId] = { 
                ...state.devices[deviceId], 
                ...device,
                lastUpdated: Date.now(),
                lastSeen: Date.now()
            };
            
            let li = document.getElementById(`device-${deviceId}`);
            if (!li) {
                li = document.createElement('li');
                li.className = 'device';
                li.id = `device-${deviceId}`;
                li.addEventListener('click', () => {
                    if (device.socketId) {
                        console.log(`üì± Switching to device: ${device.deviceName}`);
                        state.activeDeviceId = deviceId;
                        UIElements.deviceTitle.textContent = `${device.deviceName}`;
                        UIElements.lockStatus.textContent = `Lock: ${device.lockType || 'Unknown'}`;
                        UIElements.lockStatus.style.color = device.lockType === 'locked' ? '#ff4444' : '#44ff44';
                        
                        showView('control-view');
                        
                        // Auto-start live stream
                        setTimeout(() => {
                            startLiveStream();
                            setupClickHandler();
                        }, 1000);
                    } else {
                        alert('‚ö†Ô∏è Device is currently offline. Please wait for it to reconnect.');
                    }
                });
                UIElements.deviceList.appendChild(li);
            }
            
            const isOnline = !!device.socketId;
            const batteryLevel = device.battery || 'N/A';
            const batteryColor = batteryLevel < 20 ? '#ff4444' : batteryLevel < 50 ? '#ffaa00' : '#44ff44';
            
            li.innerHTML = `
                <div style="flex: 1;">
                    <div class="device-name">${device.deviceName || 'Unknown Device'}</div>
                    <div class="device-info">
                        üì± Android ${device.androidVersion || 'Unknown'} | 
                        üîã <span style="color: ${batteryColor}">${batteryLevel}%</span> | 
                        <span style="color: ${isOnline ? '#44ff44' : '#ff4444'}">
                            ${isOnline ? '‚óè Online' : '‚óè Offline'}
                        </span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="lock-badge ${device.lockType !== 'locked' ? 'unlocked' : ''}">
                        ${(device.lockType || 'none').toUpperCase()}
                    </span>
                    <span class="status-dot" style="background-color: ${isOnline ? '#44ff44' : '#ff4444'}; 
                         box-shadow: 0 0 10px ${isOnline ? '#44ff44' : '#ff4444'}">
                    </span>
                </div>
            `;
        }

        function showView(viewId) {
            UIElements.deviceListView.classList.remove('active');
            UIElements.controlView.classList.remove('active');
            
            document.getElementById(viewId).classList.add('active');
            
            if (viewId === 'device-list-view') {
                stopLiveStream();
                state.activeDeviceId = null;
                UIElements.coordsDisplay.style.display = 'none';
                UIElements.debugInfo.style.display = 'none';
                UIElements.testClickArea.style.display = 'none';
            }
        }

        // SOCKET.IO EVENT HANDLERS
        socket.on('connect', () => {
            console.log('‚úÖ CONNECTED to server');
            state.connectionStartTime = Date.now();
            state.connectionAttempts = 0;
            
            UIElements.connectionDot.className = 'connection-dot connected';
            UIElements.connectionStatusText.textContent = 'Connected';
            UIElements.connectionStatusText.style.color = '#44ff44';
            
            socket.emit('admin_join');
            console.log('üëë Joined as admin');
        });

        socket.on('disconnect', (reason) => {
            console.warn('‚ùå DISCONNECTED from server. Reason:', reason);
            
            UIElements.connectionDot.className = 'connection-dot disconnected';
            UIElements.connectionStatusText.textContent = `Disconnected: ${reason}`;
            UIElements.connectionStatusText.style.color = '#ff4444';
            
            state.connectionAttempts++;
            
            setTimeout(() => {
                if (!socket.connected) {
                    console.log('üîÑ Attempting to reconnect...');
                    socket.connect();
                }
            }, 2000);
        });

        socket.on('connect_error', (error) => {
            console.error('üîå Connection error:', error.message);
            UIElements.connectionStatusText.textContent = `Error: ${error.message}`;
            UIElements.connectionStatusText.style.color = '#ffaa00';
        });

        socket.on('reconnect', (attemptNumber) => {
            console.log(`üîÑ RECONNECTED after ${attemptNumber} attempts`);
            UIElements.connectionStatusText.textContent = 'Reconnected ‚úì';
            UIElements.connectionStatusText.style.color = '#44ff44';
        });

        // DEVICE DATA HANDLERS
        socket.on('device_list', (initialDevices) => {
            console.log(`üìã Received ${initialDevices.length} devices`);
            UIElements.deviceList.innerHTML = '';
            state.devices = {};
            
            initialDevices.forEach(device => {
                if (device && device.deviceId) {
                    updateDeviceInList(device);
                }
            });
        });

        socket.on('new_device_joined', (device) => {
            console.log(`‚ûï New device joined: ${device.deviceName}`);
            updateDeviceInList(device);
        });

        socket.on('device_disconnected', (deviceId) => {
            console.log(`‚ûñ Device disconnected: ${deviceId}`);
            const el = document.getElementById(`device-${deviceId}`);
            if (el) {
                el.querySelector('.status-dot').style.backgroundColor = '#ff4444';
            }
            
            if (state.devices[deviceId]) {
                state.devices[deviceId].socketId = null;
            }
            
            if (state.activeDeviceId === deviceId) {
                alert('‚ö†Ô∏è Device disconnected. It will reconnect automatically.');
                stopLiveStream();
            }
        });

        socket.on('device_heartbeat', (data) => {
            if (data && data.deviceId && state.devices[data.deviceId]) {
                updateDeviceInList({...state.devices[data.deviceId], ...data});
                
                if (data.deviceId === state.activeDeviceId) {
                    UIElements.lockStatus.textContent = `Lock: ${data.lockType || 'Unknown'}`;
                    UIElements.lockStatus.style.color = data.lockType === 'locked' ? '#ff4444' : '#44ff44';
                }
            }
        });

        socket.on('live_screen', (data) => {
            if (!data || !data.liveImage) return;
            
            if (data.deviceId !== state.activeDeviceId || !state.isLiveStreaming) return;
            
            // Update last seen
            if (state.devices[data.deviceId]) {
                state.devices[data.deviceId].lastSeen = Date.now();
            }
            
            // Store screen dimensions
            if (data.screenWidth && data.screenHeight) {
                state.screenDimensions.width = data.screenWidth;
                state.screenDimensions.height = data.screenHeight;
                
                // Calculate scale factor for display
                const img = UIElements.liveScreenImage;
                if (img.naturalWidth > 0) {
                    state.scaleFactor = data.screenWidth / img.naturalWidth;
                }
            }
            
            // Update screen image
            UIElements.liveScreenImage.src = `data:image/jpeg;base64,${data.liveImage}`;
            
            // Update alt text with dimensions
            UIElements.liveScreenImage.alt = `Live Screen - ${state.screenDimensions.width}x${state.screenDimensions.height}`;
            
            // Store image data
            state.currentImageData = data;
            
            // Setup click handler if not already done
            if (!state.clickHandlerSetup) {
                setupClickHandler();
                state.clickHandlerSetup = true;
            }
        });

        // UI EVENT LISTENERS
        UIElements.backToListBtn.onclick = () => {
            console.log('‚Üê Going back to device list');
            showView('device-list-view');
        };

        UIElements.liveScreenBtn.onclick = () => {
            if (!state.isLiveStreaming) {
                startLiveStream();
            } else {
                stopLiveStream();
            }
        };

        UIElements.testClickBtn.onclick = () => {
            calibrateClick();
        };

        UIElements.calibrateClickBtn.onclick = calibrateClick;

        // CONTROL BUTTONS
        document.getElementById('btn-start-stream').onclick = startLiveStream;
        document.getElementById('btn-stop-stream').onclick = stopLiveStream;
        document.getElementById('btn-wake-unlock').onclick = () => sendCommand('unlock_device');
        document.getElementById('btn-back').onclick = () => sendCommand('global_action', { action: 'back' });
        document.getElementById('btn-home').onclick = () => sendCommand('global_action', { action: 'home' });
        document.getElementById('btn-recents').onclick = () => sendCommand('global_action', { action: 'recents' });
        document.getElementById('btn-scroll-up').onclick = () => sendCommand('scroll_action', { direction: 'up' });
        document.getElementById('btn-scroll-down').onclick = () => sendCommand('scroll_action', { direction: 'down' });
        document.getElementById('btn-scroll-left').onclick = () => sendCommand('scroll_action', { direction: 'left' });
        document.getElementById('btn-scroll-right').onclick = () => sendCommand('scroll_action', { direction: 'right' });

        // PERIODIC UPDATES
        setInterval(() => {
            if (socket.connected) {
                const uptime = Math.floor((Date.now() - state.connectionStartTime) / 1000);
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                const seconds = uptime % 60;
                
                UIElements.connectionStats.textContent = 
                    `Uptime: ${hours}h ${minutes}m ${seconds}s | Devices: ${Object.keys(state.devices).length}`;
            }
        }, 1000);

        // INITIALIZE
        console.log('üöÄ Screen Control Panel Initialized');
        UIElements.connectionStatusText.textContent = 'Connecting to server...';

        // Auto-connect
        if (!socket.connected) {
            socket.connect();
        }

    </script>
</body>
</html>
